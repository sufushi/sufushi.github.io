<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="android基础篇," />










<meta name="description" content="前言ListView——列表，它作为一个非常重要的显示方式，不管是在Web中还是在移动平台中，都是一个非常好的、不可或缺的展示信息的工具。在android中，ListView控件接管了这一重担，在大量的场合下，我们都需要使用这个控件。虽然在5.X时代，RecyclerView在很多地方逐渐取代了ListView，但ListView的使用范围还是非常广泛。
ListView显示需要三要素：

Lis">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解ListView工作原理">
<meta property="og:url" content="sufushi.github.io/2017/11/19/深入理解ListView工作原理（一）/index.html">
<meta property="og:site_name" content="苏富仕的博客">
<meta property="og:description" content="前言ListView——列表，它作为一个非常重要的显示方式，不管是在Web中还是在移动平台中，都是一个非常好的、不可或缺的展示信息的工具。在android中，ListView控件接管了这一重担，在大量的场合下，我们都需要使用这个控件。虽然在5.X时代，RecyclerView在很多地方逐渐取代了ListView，但ListView的使用范围还是非常广泛。
ListView显示需要三要素：

Lis">
<meta property="og:image" content="http://oxsxuoiqx.bkt.clouddn.com/ListView%E7%9A%84%E7%BB%A7%E6%89%BF%E7%BB%93%E6%9E%84%E5%9B%BE.png">
<meta property="og:image" content="http://img.blog.csdn.net/20150719202924532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">
<meta property="og:image" content="http://img.blog.csdn.net/20150719213754421?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">
<meta property="og:updated_time" content="2018-02-26T09:34:22.436Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解ListView工作原理">
<meta name="twitter:description" content="前言ListView——列表，它作为一个非常重要的显示方式，不管是在Web中还是在移动平台中，都是一个非常好的、不可或缺的展示信息的工具。在android中，ListView控件接管了这一重担，在大量的场合下，我们都需要使用这个控件。虽然在5.X时代，RecyclerView在很多地方逐渐取代了ListView，但ListView的使用范围还是非常广泛。
ListView显示需要三要素：

Lis">
<meta name="twitter:image" content="http://oxsxuoiqx.bkt.clouddn.com/ListView%E7%9A%84%E7%BB%A7%E6%89%BF%E7%BB%93%E6%9E%84%E5%9B%BE.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="sufushi.github.io/2017/11/19/深入理解ListView工作原理（一）/"/>





  <title>深入理解ListView工作原理 | 苏富仕的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">苏富仕的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">-4</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="sufushi.github.io/2017/11/19/深入理解ListView工作原理（一）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sufushi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏富仕的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">深入理解ListView工作原理</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-19T22:15:02+08:00">
                2017-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>ListView——列表，它作为一个非常重要的显示方式，不管是在Web中还是在移动平台中，都是一个非常好的、不可或缺的展示信息的工具。在android中，ListView控件接管了这一重担，在大量的场合下，我们都需要使用这个控件。虽然在5.X时代，RecyclerView在很多地方逐渐取代了ListView，但ListView的使用范围还是非常广泛。</p>
<p>ListView显示需要三要素：</p>
<ul>
<li>ListView是用来展示列表的View。</li>
<li>适配器Adapter是用来把数据映射到ListView上的中介。</li>
<li>数据是具体的将要被映射的字符串、图片或者基本组件。</li>
</ul>
<p>ListView还有一个神奇的功能，相信大多数人都体验过，即使在ListView中加载非常多的数据，ListView都不会发生OOM或者奔溃，而且随着我们手指滑动来浏览更多数据时，程序所占用的内存竟然都不会跟着增长，这里涉及到ListView的视图缓存机制。</p>
<p>ListView的继承结构如下。</p>
<p><img src="http://oxsxuoiqx.bkt.clouddn.com/ListView%E7%9A%84%E7%BB%A7%E6%89%BF%E7%BB%93%E6%9E%84%E5%9B%BE.png" alt="ListView的继承结构图"></p>
<p>可以看到，ListView的继承结构还是相当复杂的，它是直接继承自AbsListView，而AbsListView有两个子实现类，一个是ListView，另一个就是GridView，因此从这一点可以猜出ListView和GridView在工作原理和实现上都是有很多共同点的。然后AbsListView又继承自AdapterView，AdapterView继承自ViewGroup，最后再到View和Object。</p>
<h4 id="Adapter的作用"><a href="#Adapter的作用" class="headerlink" title="Adapter的作用"></a>Adapter的作用</h4><p>归根结底，一个View控件就是为了交互和展示数据用的，只不过ListView更加特殊，它是为了展示很多数据用的，但是ListView只承担交互和展示工作而已，至于这些数据来自哪里，ListView并不关心。因此，我们能设想到的最基本的ListView工作模式就是要有一个ListView控件和一个数据源。</p>
<p>不过如果真的让ListView和数据源直接打交道的话，那ListView所要做的适配工作就非常复杂了。因为数据源这个概念太模糊了，我们只知道它包含了很多数据而已，至于这个数据源到底是什么类型，并没有严格的定义，有可能是数组或集合，甚至有可能是数据库表中查询出来的游标。所以说如果让ListView为每一种数据源都进行适配操作的话，一是扩展性会比较差，内置了几种适配就只有几种适配，不能动态进行添加，二是超出了它本身应该负责的工作范围，不再是仅仅承担交互和展示工作就可以了，这样ListView就会变得很臃肿。</p>
<p>于是就有了Adapter这样一个机制的出现。Adapter在ListView和数据源之间起到了一个桥梁的作用，ListView并不会直接和数据源打交道，而是会借助Adapter这个桥梁来去访问真正的数据源，与之前接口不同的是，Adapter的接口都是统一的，因此ListView不用再去担心任何适配方面的问题。而Adapter又是一个接口，它可以去实现各种各样的子类，每个子类都能通过自己的逻辑去完成特定的功能，以及与特定数据源的适配操作，比如ArrayAdapter可以用于数组和List类型的数据源适配，SimpleCursorAdapter可以用于游标类型的数据源适配，这样就非常巧妙地把数据源适配困难的问题解决掉了，并且还拥有相当不错的扩展性。简单的原理示意图如下所示。</p>
<p><img src="http://img.blog.csdn.net/20150719202924532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></p>
<p>当然Adapter的作用不仅仅只有数据源适配这一点，还有一个非常重要的方法也需要我们在Adapter当中去重写，就是getView()方法。</p>
<h4 id="RecyclerBin机制"><a href="#RecyclerBin机制" class="headerlink" title="RecyclerBin机制"></a>RecyclerBin机制</h4><p>在开始分析ListView源码之前，有一个东西是我们需要提前了解的，就是RecyclerBin机制，这个机制也是ListView能够实现成百上千条数据都不会OOM最重要的一个原因。RecyclerBin的代码并不多，它是写在AbsListView中的一个内部类。先来看一下RecyclerBin中的主要代码实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecycleBin</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> RecyclerListener mRecyclerListener;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mFirstActivePosition;</div><div class="line">        <span class="keyword">private</span> View[] mActiveViews = <span class="keyword">new</span> View[<span class="number">0</span>];</div><div class="line">        <span class="keyword">private</span> ArrayList&lt;View&gt;[] mScrapViews;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mViewTypeCount;</div><div class="line">        <span class="keyword">private</span> ArrayList&lt;View&gt; mCurrentScrap;</div><div class="line">        <span class="keyword">private</span> ArrayList&lt;View&gt; mSkippedScrap;</div><div class="line">        <span class="keyword">private</span> SparseArray&lt;View&gt; mTransientStateViews;</div><div class="line">        <span class="keyword">private</span> LongSparseArray&lt;View&gt; mTransientStateViewsById;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setViewTypeCount</span><span class="params">(<span class="keyword">int</span> viewTypeCount)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (viewTypeCount &lt; <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't have a viewTypeCount &lt; 1"</span>);</div><div class="line">            &#125;</div><div class="line">            ArrayList&lt;View&gt;[] scrapViews = <span class="keyword">new</span> ArrayList[viewTypeCount];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; i++) &#123;</div><div class="line">                scrapViews[i] = <span class="keyword">new</span> ArrayList&lt;View&gt;();</div><div class="line">            &#125;</div><div class="line">            mViewTypeCount = viewTypeCount;</div><div class="line">            mCurrentScrap = scrapViews[<span class="number">0</span>];</div><div class="line">            mScrapViews = scrapViews;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">markChildrenDirty</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; scrapCount; i++) &#123;</div><div class="line">                    scrap.get(i).forceLayout();</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">                    <span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">                        scrap.get(j).forceLayout();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mTransientStateViews != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> count = mTransientStateViews.size();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                    mTransientStateViews.valueAt(i).forceLayout();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mTransientStateViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> count = mTransientStateViewsById.size();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                    mTransientStateViewsById.valueAt(i).forceLayout();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldRecycleViewType</span><span class="params">(<span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> viewType &gt;= <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">                clearScrap(scrap);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">                    <span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">                    clearScrap(scrap);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            clearTransientStateViews();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">fillActiveViews</span><span class="params">(<span class="keyword">int</span> childCount, <span class="keyword">int</span> firstActivePosition)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mActiveViews.length &lt; childCount) &#123;</div><div class="line">                mActiveViews = <span class="keyword">new</span> View[childCount];</div><div class="line">            &#125;</div><div class="line">            mFirstActivePosition = firstActivePosition;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">                View child = getChildAt(i);</div><div class="line">                AbsListView.LayoutParams lp = (AbsListView.LayoutParams) child.getLayoutParams();</div><div class="line">                <span class="keyword">if</span> (lp != <span class="keyword">null</span> &amp;&amp; lp.viewType != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">                    activeViews[i] = child;</div><div class="line">                    lp.scrappedFromPosition = firstActivePosition + i;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function">View <span class="title">getActiveView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">int</span> index = position - mFirstActivePosition;</div><div class="line">            <span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">            <span class="keyword">if</span> (index &gt;=<span class="number">0</span> &amp;&amp; index &lt; activeViews.length) &#123;</div><div class="line">                <span class="keyword">final</span> View match = activeViews[index];</div><div class="line">                activeViews[index] = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">return</span> match;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function">View <span class="title">getTransientStateView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds &amp;&amp; mTransientStateViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">long</span> id = mAdapter.getItemId(position);</div><div class="line">                View result = mTransientStateViewsById.get(id);</div><div class="line">                mTransientStateViewsById.remove(id);</div><div class="line">                <span class="keyword">return</span> result;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mTransientStateViews != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = mTransientStateViews.indexOfKey(position);</div><div class="line">                <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    View result = mTransientStateViews.valueAt(index);</div><div class="line">                    mTransientStateViews.removeAt(index);</div><div class="line">                    <span class="keyword">return</span> result;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">clearTransientStateViews</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> SparseArray&lt;View&gt; viewsByPos = mTransientStateViews;</div><div class="line">            <span class="keyword">if</span> (viewsByPos != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = viewsByPos.size();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">                    removeDetachedView(viewsByPos.valueAt(i), <span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">                viewsByPos.clear();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> LongSparseArray&lt;View&gt; viewsById = mTransientStateViewsById;</div><div class="line">            <span class="keyword">if</span> (viewsById != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = viewsById.size();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">                    removeDetachedView(viewsById.valueAt(i), <span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">                viewsById.clear();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function">View <span class="title">getScrapView</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> whichScrap = mAdapter.getItemViewType(position);</div><div class="line">            <span class="keyword">if</span> (whichScrap &lt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">return</span> retrieveFromScrap(mCurrentScrap, position);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (whichScrap &lt; mScrapViews.length) &#123;</div><div class="line">                <span class="keyword">return</span> retrieveFromScrap(mScrapViews[whichScrap], position);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">addScrapView</span><span class="params">(View scrap, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> AbsListView.LayoutParams lp = (AbsListView.LayoutParams) scrap.getLayoutParams();</div><div class="line">            <span class="keyword">if</span> (lp == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            lp.scrappedFromPosition = position;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> viewType = lp.viewType;</div><div class="line">            <span class="keyword">if</span> (!shouldRecycleViewType(viewType)) &#123;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (viewType != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">                    getSkippedScrap().add(scrap);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            scrap.dispatchStartTemporaryDetach();</div><div class="line">            notifyViewAccessibilityStateChangedIfNeeded(</div><div class="line">                    AccessibilityEvent.CONTENT_CHANGE_TYPE_SUBTREE);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> scrapHasTransientState = scrap.hasTransientState();</div><div class="line">            <span class="keyword">if</span> (scrapHasTransientState) &#123;</div><div class="line">                <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds) &#123;</div><div class="line">                    <span class="keyword">if</span> (mTransientStateViewsById == <span class="keyword">null</span>) &#123;</div><div class="line">                        mTransientStateViewsById = <span class="keyword">new</span> LongSparseArray&lt;&gt;();</div><div class="line">                    &#125;</div><div class="line">                    mTransientStateViewsById.put(lp.itemId, scrap);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">                    <span class="keyword">if</span> (mTransientStateViews == <span class="keyword">null</span>) &#123;</div><div class="line">                        mTransientStateViews = <span class="keyword">new</span> SparseArray&lt;&gt;();</div><div class="line">                    &#125;</div><div class="line">                    mTransientStateViews.put(position, scrap);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    getSkippedScrap().add(scrap);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">                    mCurrentScrap.add(scrap);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mScrapViews[viewType].add(scrap);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (mRecyclerListener != <span class="keyword">null</span>) &#123;</div><div class="line">                    mRecyclerListener.onMovedToScrapHeap(scrap);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> ArrayList&lt;View&gt; <span class="title">getSkippedScrap</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mSkippedScrap == <span class="keyword">null</span>) &#123;</div><div class="line">                mSkippedScrap = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> mSkippedScrap;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">removeSkippedScrap</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mSkippedScrap == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> count = mSkippedScrap.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                removeDetachedView(mSkippedScrap.get(i), <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">            mSkippedScrap.clear();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">scrapActiveViews</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> hasListener = mRecyclerListener != <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> multipleScraps = mViewTypeCount &gt; <span class="number">1</span>;</div><div class="line">            ArrayList&lt;View&gt; scrapViews = mCurrentScrap;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> count = activeViews.length;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                <span class="keyword">final</span> View victim = activeViews[i];</div><div class="line">                <span class="keyword">if</span> (victim != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> AbsListView.LayoutParams lp</div><div class="line">                            = (AbsListView.LayoutParams) victim.getLayoutParams();</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> whichScrap = lp.viewType;</div><div class="line">                    activeViews[i] = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">if</span> (victim.hasTransientState()) &#123;</div><div class="line">                        victim.dispatchStartTemporaryDetach();</div><div class="line"></div><div class="line">                        <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span> &amp;&amp; mAdapterHasStableIds) &#123;</div><div class="line">                            <span class="keyword">if</span> (mTransientStateViewsById == <span class="keyword">null</span>) &#123;</div><div class="line">                                mTransientStateViewsById = <span class="keyword">new</span> LongSparseArray&lt;View&gt;();</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">long</span> id = mAdapter.getItemId(mFirstActivePosition + i);</div><div class="line">                            mTransientStateViewsById.put(id, victim);</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">                            <span class="keyword">if</span> (mTransientStateViews == <span class="keyword">null</span>) &#123;</div><div class="line">                                mTransientStateViews = <span class="keyword">new</span> SparseArray&lt;View&gt;();</div><div class="line">                            &#125;</div><div class="line">                            mTransientStateViews.put(mFirstActivePosition + i, victim);</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (whichScrap != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">                            removeDetachedView(victim, <span class="keyword">false</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!shouldRecycleViewType(whichScrap)) &#123;</div><div class="line">                        <span class="keyword">if</span> (whichScrap != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">                            removeDetachedView(victim, <span class="keyword">false</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">if</span> (multipleScraps) &#123;</div><div class="line">                            scrapViews = mScrapViews[whichScrap];</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        lp.scrappedFromPosition = mFirstActivePosition + i;</div><div class="line">                        removeDetachedView(victim, <span class="keyword">false</span>);</div><div class="line">                        scrapViews.add(victim);</div><div class="line"></div><div class="line">                        <span class="keyword">if</span> (hasListener) &#123;</div><div class="line">                            mRecyclerListener.onMovedToScrapHeap(victim);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            pruneScrapViews();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">fullyDetachScrapViews</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> viewTypeCount = mViewTypeCount;</div><div class="line">            <span class="keyword">final</span> ArrayList&lt;View&gt;[] scrapViews = mScrapViews;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; ++i) &#123;</div><div class="line">                <span class="keyword">final</span> ArrayList&lt;View&gt; scrapPile = scrapViews[i];</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = scrapPile.size() - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</div><div class="line">                    <span class="keyword">final</span> View view = scrapPile.get(j);</div><div class="line">                    <span class="keyword">if</span> (view.isTemporarilyDetached()) &#123;</div><div class="line">                        removeDetachedView(view, <span class="keyword">false</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pruneScrapViews</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> maxViews = mActiveViews.length;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> viewTypeCount = mViewTypeCount;</div><div class="line">            <span class="keyword">final</span> ArrayList&lt;View&gt;[] scrapViews = mScrapViews;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; ++i) &#123;</div><div class="line">                <span class="keyword">final</span> ArrayList&lt;View&gt; scrapPile = scrapViews[i];</div><div class="line">                <span class="keyword">int</span> size = scrapPile.size();</div><div class="line">                <span class="keyword">while</span> (size &gt; maxViews) &#123;</div><div class="line">                    scrapPile.remove(--size);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> SparseArray&lt;View&gt; transViewsByPos = mTransientStateViews;</div><div class="line">            <span class="keyword">if</span> (transViewsByPos != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transViewsByPos.size(); i++) &#123;</div><div class="line">                    <span class="keyword">final</span> View v = transViewsByPos.valueAt(i);</div><div class="line">                    <span class="keyword">if</span> (!v.hasTransientState()) &#123;</div><div class="line">                        removeDetachedView(v, <span class="keyword">false</span>);</div><div class="line">                        transViewsByPos.removeAt(i);</div><div class="line">                        i--;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> LongSparseArray&lt;View&gt; transViewsById = mTransientStateViewsById;</div><div class="line">            <span class="keyword">if</span> (transViewsById != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transViewsById.size(); i++) &#123;</div><div class="line">                    <span class="keyword">final</span> View v = transViewsById.valueAt(i);</div><div class="line">                    <span class="keyword">if</span> (!v.hasTransientState()) &#123;</div><div class="line">                        removeDetachedView(v, <span class="keyword">false</span>);</div><div class="line">                        transViewsById.removeAt(i);</div><div class="line">                        i--;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">reclaimScrapViews</span><span class="params">(List&lt;View&gt; views)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">                views.addAll(mCurrentScrap);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> viewTypeCount = mViewTypeCount;</div><div class="line">                <span class="keyword">final</span> ArrayList&lt;View&gt;[] scrapViews = mScrapViews;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewTypeCount; ++i) &#123;</div><div class="line">                    <span class="keyword">final</span> ArrayList&lt;View&gt; scrapPile = scrapViews[i];</div><div class="line">                    views.addAll(scrapPile);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setCacheColorHint</span><span class="params">(<span class="keyword">int</span> color)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mViewTypeCount == <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mCurrentScrap;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; scrapCount; i++) &#123;</div><div class="line">                    scrap.get(i).setDrawingCacheBackgroundColor(color);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> typeCount = mViewTypeCount;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeCount; i++) &#123;</div><div class="line">                    <span class="keyword">final</span> ArrayList&lt;View&gt; scrap = mScrapViews[i];</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">                        scrap.get(j).setDrawingCacheBackgroundColor(color);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">final</span> View[] activeViews = mActiveViews;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> count = activeViews.length;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">                <span class="keyword">final</span> View victim = activeViews[i];</div><div class="line">                <span class="keyword">if</span> (victim != <span class="keyword">null</span>) &#123;</div><div class="line">                    victim.setDrawingCacheBackgroundColor(color);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> View <span class="title">retrieveFromScrap</span><span class="params">(ArrayList&lt;View&gt; scrapViews, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> size = scrapViews.size();</div><div class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">                    <span class="keyword">final</span> View view = scrapViews.get(i);</div><div class="line">                    <span class="keyword">final</span> AbsListView.LayoutParams params =</div><div class="line">                            (AbsListView.LayoutParams) view.getLayoutParams();</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (mAdapterHasStableIds) &#123;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">long</span> id = mAdapter.getItemId(position);</div><div class="line">                        <span class="keyword">if</span> (id == params.itemId) &#123;</div><div class="line">                            <span class="keyword">return</span> scrapViews.remove(i);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (params.scrappedFromPosition == position) &#123;</div><div class="line">                        <span class="keyword">final</span> View scrap = scrapViews.remove(i);</div><div class="line">                        clearAccessibilityFromScrap(scrap);</div><div class="line">                        <span class="keyword">return</span> scrap;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">final</span> View scrap = scrapViews.remove(size - <span class="number">1</span>);</div><div class="line">                clearAccessibilityFromScrap(scrap);</div><div class="line">                <span class="keyword">return</span> scrap;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearScrap</span><span class="params">(<span class="keyword">final</span> ArrayList&lt;View&gt; scrap)</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> scrapCount = scrap.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scrapCount; j++) &#123;</div><div class="line">                removeDetachedView(scrap.remove(scrapCount - <span class="number">1</span> - j), <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearAccessibilityFromScrap</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">            view.clearAccessibilityFocus();</div><div class="line">            view.setAccessibilityDelegate(<span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeDetachedView</span><span class="params">(View child, <span class="keyword">boolean</span> animate)</span> </span>&#123;</div><div class="line">            child.setAccessibilityDelegate(<span class="keyword">null</span>);</div><div class="line">            AbsListView.<span class="keyword">this</span>.removeDetachedView(child, animate);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>接下来先简单解读一下RecycleBin最主要的几个方法。</p>
<ul>
<li>fillActiveViews(int childCount, int firstActivePosition)这个方法接收两个参数，第一个参数标识要存储的view的数量，第二个参数标识ListView中第一个可见元素的position值。RecycleBin当中使用mActiveViews这个数组来存储View，调用这个方法后就会根据传入的参数来将ListView中指定的元素存储到mActiveViews数组中。</li>
<li>View getActiveView(int position)这个方法和fillActiveViews()是对应的，用于从mActiveViews数组当中获取数据。该方法接收一个position参数，表示元素在ListView当中的位置，方法内部会自动将position值转换成mActiveViews数组对应的下标值。需要注意的是，mActiveViews当中所存储的View，一旦被获取了之后就会从mActiveViews当中移除，下次获取同样位置的View将会返回null，也就是说mActiveViews不能被重复利用。</li>
<li>void addScrapView(View scrap, int position)用于将一个废弃的View进行缓存，该方法接收一个View参数，当有某个View确定要废弃掉的时候（比如滚动出了屏幕），就应该调用这个方法来对View进行缓存，RecycleBin当中使用mScrapViews和mCurrentScrap这两个List来存储废弃View。</li>
<li>View getScrapView(int position)用于从废弃缓存中取出一个View，这些废弃缓存中的View是没有顺序可言的，因此getScrapView()方法中的算法也非常简单，就是直接从mCurrentScrap当中获取尾部的一个scrap view进行返回。</li>
<li>void setViewTypeCount(int viewTypeCount)。我们都知道Adapter当中可以重写一个getViewTypeCount()来表示ListView中有几种类型的数据项，而setViewTypeCount()方法的作用就是为每种类型的数据项都单独启用一个RecycleBin缓存机制。实际上，getViewTypeCount()方法通常情况下使用的并不是很多，所以我们只要知道RecycleBin当中有这样一个功能就行了。</li>
</ul>
<h4 id="ListView的布局工作原理"><a href="#ListView的布局工作原理" class="headerlink" title="ListView的布局工作原理"></a>ListView的布局工作原理</h4><p>ListView即使再特殊最终还是继承自View的，因此它的执行流程还会按照View的规则来执行。View的执行流程无非就分为3步，onMeasure()用于测量View的大小，onLayout()用于确定View的布局，onDraw()用于将View绘制到界面上。而在ListView当中，onMeasure()并没有什么特殊的地方，因为它终归是一个View，占用的空间最多并且通常也就是整个屏幕。onDraw()在listView当中也没有什么意义，因为ListView本身并不负责绘制，而是由ListView当中的子元素来进行绘制的。那么ListView大部分的神奇功能其实都是在onLayout()方法中进行的了，因此接下来主要分析这个方法的工作原理。</p>
<p>ListView的onLayout()方法是在父类AbsListView中实现的，源码实现如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>.onLayout(changed, l, t, r, b);</div><div class="line"></div><div class="line">       mInLayout = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">       <span class="keyword">if</span> (changed) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">               getChildAt(i).forceLayout();</div><div class="line">           &#125;</div><div class="line">           mRecycler.markChildrenDirty();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       layoutChildren();</div><div class="line">       mInLayout = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">       mOverscrollMax = (b - t) / OVERSCROLL_LIMIT_DIVISOR;</div><div class="line"></div><div class="line">       <span class="comment">// <span class="doctag">TODO:</span> Move somewhere sane. This doesn't belong in onLayout().</span></div><div class="line">       <span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span>) &#123;</div><div class="line">           mFastScroll.onItemCountChanged(getChildCount(), mItemCount);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到，onLayout()方法中并没有做什么复杂的逻辑操作，主要就是一个判断，如果ListView的大小或位置发生了变化，那么changed变量就会变成true，此时会要求所有的子布局都强制进行重绘。再看到layoutChildren()这个方法，这个方法是用来进行子元素布局的，但是这个方法是个空方法，因为子元素的布局应该是由具体的实现类来负责完成的，而不是由父类来完成的。所以，进入ListView的layoutChildren()方法进一步分析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> blockLayoutRequests = mBlockLayoutRequests;</div><div class="line">    <span class="keyword">if</span> (blockLayoutRequests) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mBlockLayoutRequests = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">super</span>.layoutChildren();</div><div class="line"></div><div class="line">        invalidate();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mAdapter == <span class="keyword">null</span>) &#123;</div><div class="line">            resetList();</div><div class="line">            invokeOnItemScrollListener();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childrenTop = mListPadding.top;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childrenBottom = mBottom - mTop - mListPadding.bottom;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line"></div><div class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> delta = <span class="number">0</span>;</div><div class="line"></div><div class="line">        View sel;</div><div class="line">        View oldSel = <span class="keyword">null</span>;</div><div class="line">        View oldFirst = <span class="keyword">null</span>;</div><div class="line">        View newSel = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">        <span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">            index = mNextSelectedPosition - mFirstPosition;</div><div class="line">            <span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">                newSel = getChildAt(index);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">        <span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">        <span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">        <span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            index = mSelectedPosition - mFirstPosition;</div><div class="line">            <span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">                oldSel = getChildAt(index);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            oldFirst = getChildAt(<span class="number">0</span>);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mNextSelectedPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">                delta = mNextSelectedPosition - mSelectedPosition;</div><div class="line">            &#125;</div><div class="line">            newSel = getChildAt(index + delta);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> dataChanged = mDataChanged;</div><div class="line">        <span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">            handleDataChanged();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mItemCount == <span class="number">0</span>) &#123;</div><div class="line">            resetList();</div><div class="line">            invokeOnItemScrollListener();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mItemCount != mAdapter.getCount()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The content of the adapter has changed but "</span></div><div class="line">                    + <span class="string">"ListView did not receive a notification. Make sure the content of "</span></div><div class="line">                    + <span class="string">"your adapter is not modified from a background thread, but only from "</span></div><div class="line">                    + <span class="string">"the UI thread. Make sure your adapter calls notifyDataSetChanged() "</span></div><div class="line">                    + <span class="string">"when its content changes. [in ListView("</span> + getId() + <span class="string">", "</span> + getClass()</div><div class="line">                    + <span class="string">") with Adapter("</span> + mAdapter.getClass() + <span class="string">")]"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setSelectedPositionInt(mNextSelectedPosition);</div><div class="line"></div><div class="line">        AccessibilityNodeInfo accessibilityFocusLayoutRestoreNode = <span class="keyword">null</span>;</div><div class="line">        View accessibilityFocusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">int</span> accessibilityFocusPosition = INVALID_POSITION;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> ViewRootImpl viewRootImpl = getViewRootImpl();</div><div class="line">        <span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> View focusHost = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">            <span class="keyword">if</span> (focusHost != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> View focusChild = getAccessibilityFocusedChild(focusHost);</div><div class="line">                <span class="keyword">if</span> (focusChild != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusChild)</div><div class="line">                            || focusChild.hasTransientState() || mAdapterHasStableIds) &#123;</div><div class="line">                        accessibilityFocusLayoutRestoreView = focusHost;</div><div class="line">                        accessibilityFocusLayoutRestoreNode = viewRootImpl</div><div class="line">                                .getAccessibilityFocusedVirtualView();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    accessibilityFocusPosition = getPositionForView(focusChild);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        View focusLayoutRestoreDirectChild = <span class="keyword">null</span>;</div><div class="line">        View focusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> View focusedChild = getFocusedChild();</div><div class="line">        <span class="keyword">if</span> (focusedChild != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusedChild)</div><div class="line">                    || focusedChild.hasTransientState() || mAdapterHasStableIds) &#123;</div><div class="line">                focusLayoutRestoreDirectChild = focusedChild;</div><div class="line">                focusLayoutRestoreView = findFocus();</div><div class="line">                <span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">                    focusLayoutRestoreView.dispatchStartTemporaryDetach();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            requestFocus();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</div><div class="line">        <span class="keyword">final</span> RecycleBin recycleBin = mRecycler;</div><div class="line">      </div><div class="line">        <span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">                recycleBin.addScrapView(getChildAt(i), firstPosition+i);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            recycleBin.fillActiveViews(childCount, firstPosition);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        detachAllViewsFromParent();</div><div class="line">        recycleBin.removeSkippedScrap();</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">        <span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">            <span class="keyword">if</span> (newSel != <span class="keyword">null</span>) &#123;</div><div class="line">                sel = fillFromSelection(newSel.getTop(), childrenTop, childrenBottom);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                sel = fillFromMiddle(childrenTop, childrenBottom);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">            sel = fillSpecific(mSyncPosition, mSpecificTop);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">            sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">            adjustViewsUpOrDown();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">            mFirstPosition = <span class="number">0</span>;</div><div class="line">            sel = fillFromTop(childrenTop);</div><div class="line">            adjustViewsUpOrDown();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> selectedPosition = reconcileSelectedPosition();</div><div class="line">            sel = fillSpecific(selectedPosition, mSpecificTop);</div><div class="line">            <span class="keyword">if</span> (sel == <span class="keyword">null</span> &amp;&amp; mFocusSelector != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> Runnable focusRunnable = mFocusSelector</div><div class="line">                        .setupFocusIfValid(selectedPosition);</div><div class="line">                <span class="keyword">if</span> (focusRunnable != <span class="keyword">null</span>) &#123;</div><div class="line">                    post(focusRunnable);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">            sel = moveSelection(oldSel, newSel, delta, childrenTop, childrenBottom);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (!mStackFromBottom) &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                    setSelectedPositionInt(position);</div><div class="line">                    sel = fillFromTop(childrenTop);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(mItemCount - <span class="number">1</span>, <span class="keyword">false</span>);</div><div class="line">                    setSelectedPositionInt(position);</div><div class="line">                    sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (mSelectedPosition &gt;= <span class="number">0</span> &amp;&amp; mSelectedPosition &lt; mItemCount) &#123;</div><div class="line">                    sel = fillSpecific(mSelectedPosition,</div><div class="line">                            oldSel == <span class="keyword">null</span> ? childrenTop : oldSel.getTop());</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFirstPosition &lt; mItemCount) &#123;</div><div class="line">                    sel = fillSpecific(mFirstPosition,</div><div class="line">                            oldFirst == <span class="keyword">null</span> ? childrenTop : oldFirst.getTop());</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    sel = fillSpecific(<span class="number">0</span>, childrenTop);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        recycleBin.scrapActiveViews();</div><div class="line"></div><div class="line">        removeUnusedFixedViews(mHeaderViewInfos);</div><div class="line">        removeUnusedFixedViews(mFooterViewInfos);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (sel != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mItemsCanFocus &amp;&amp; hasFocus() &amp;&amp; !sel.hasFocus()) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> focusWasTaken = (sel == focusLayoutRestoreDirectChild &amp;&amp;</div><div class="line">                        focusLayoutRestoreView != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                        focusLayoutRestoreView.requestFocus()) || sel.requestFocus();</div><div class="line">                <span class="keyword">if</span> (!focusWasTaken) &#123;</div><div class="line">                    <span class="keyword">final</span> View focused = getFocusedChild();</div><div class="line">                    <span class="keyword">if</span> (focused != <span class="keyword">null</span>) &#123;</div><div class="line">                        focused.clearFocus();</div><div class="line">                    &#125;</div><div class="line">                    positionSelector(INVALID_POSITION, sel);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    sel.setSelected(<span class="keyword">false</span>);</div><div class="line">                    mSelectorRect.setEmpty();</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                positionSelector(INVALID_POSITION, sel);</div><div class="line">            &#125;</div><div class="line">            mSelectedTop = sel.getTop();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> inTouchMode = mTouchMode == TOUCH_MODE_TAP</div><div class="line">                    || mTouchMode == TOUCH_MODE_DONE_WAITING;</div><div class="line">            <span class="keyword">if</span> (inTouchMode) &#123;</div><div class="line">                <span class="keyword">final</span> View child = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">                <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">                    positionSelector(mMotionPosition, child);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">                <span class="keyword">final</span> View child = getChildAt(mSelectorPosition - mFirstPosition);</div><div class="line">                <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">                    positionSelector(mSelectorPosition, child);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mSelectedTop = <span class="number">0</span>;</div><div class="line">                mSelectorRect.setEmpty();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (hasFocus() &amp;&amp; focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">                focusLayoutRestoreView.requestFocus();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> View newAccessibilityFocusedView = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">            <span class="keyword">if</span> (newAccessibilityFocusedView == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (accessibilityFocusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">                        &amp;&amp; accessibilityFocusLayoutRestoreView.isAttachedToWindow()) &#123;</div><div class="line">                    <span class="keyword">final</span> AccessibilityNodeProvider provider =</div><div class="line">                            accessibilityFocusLayoutRestoreView.getAccessibilityNodeProvider();</div><div class="line">                    <span class="keyword">if</span> (accessibilityFocusLayoutRestoreNode != <span class="keyword">null</span> &amp;&amp; provider != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> virtualViewId = AccessibilityNodeInfo.getVirtualDescendantId(</div><div class="line">                                accessibilityFocusLayoutRestoreNode.getSourceNodeId());</div><div class="line">                        provider.performAction(virtualViewId,</div><div class="line">                                AccessibilityNodeInfo.ACTION_ACCESSIBILITY_FOCUS, <span class="keyword">null</span>);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        accessibilityFocusLayoutRestoreView.requestAccessibilityFocus();</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (accessibilityFocusPosition != INVALID_POSITION) &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> position = MathUtils.constrain(</div><div class="line">                            accessibilityFocusPosition - mFirstPosition, <span class="number">0</span>,</div><div class="line">                            getChildCount() - <span class="number">1</span>);</div><div class="line">                    <span class="keyword">final</span> View restoreView = getChildAt(position);</div><div class="line">                    <span class="keyword">if</span> (restoreView != <span class="keyword">null</span>) &#123;</div><div class="line">                        restoreView.requestAccessibilityFocus();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">                &amp;&amp; focusLayoutRestoreView.getWindowToken() != <span class="keyword">null</span>) &#123;</div><div class="line">            focusLayoutRestoreView.dispatchFinishTemporaryDetach();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        mLayoutMode = LAYOUT_NORMAL;</div><div class="line">        mDataChanged = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (mPositionScrollAfterLayout != <span class="keyword">null</span>) &#123;</div><div class="line">            post(mPositionScrollAfterLayout);</div><div class="line">            mPositionScrollAfterLayout = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        mNeedSync = <span class="keyword">false</span>;</div><div class="line">        setNextSelectedPositionInt(mSelectedPosition);</div><div class="line"></div><div class="line">        updateScrollIndicators();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mItemCount &gt; <span class="number">0</span>) &#123;</div><div class="line">            checkSelectionChanged();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        invokeOnItemScrollListener();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (mFocusSelector != <span class="keyword">null</span>) &#123;</div><div class="line">            mFocusSelector.onLayoutComplete();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!blockLayoutRequests) &#123;</div><div class="line">            mBlockLayoutRequests = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ListView第一次layout过程中，ListView当中还没有任何子View，数据都还是由Adapter管理的，并没有展示到界面上，因此getChildCount()方法得到的值是0，接着会根据dataChanged这个布尔值来进行判断执行逻辑，dataChanged只有在数据源发生改变的情况下才会变成true，其他情况下都是false，因此，会进入RecycleBin的fillActiveViews()方法，这个方法调用是为了将ListView的子View进行缓存的，但是目前ListView中还没有任何子View，因此这一步暂时还起不了作用。</p>
<p>接下来会根据mLayoutMode的值来决定布局模式，默认情况下都是普通模式LAYOUT_NORMAL，因此会进入到default语句当中，紧接着进行2次if判断，childCount目前是0，并且默认的布局顺序是从上往下，因此会进入到fillFrimTop()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillFromTop</span><span class="params">(<span class="keyword">int</span> nextTop)</span> </span>&#123;</div><div class="line">    mFirstPosition = Math.min(mFirstPosition, mSelectedPosition);</div><div class="line">    mFirstPosition = Math.min(mFirstPosition, mItemCount - <span class="number">1</span>);</div><div class="line">    <span class="keyword">if</span> (mFirstPosition &lt; <span class="number">0</span>) &#123;</div><div class="line">        mFirstPosition = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> fillDown(mFirstPosition, nextTop);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法所负责的主要任务就是从mFirstPosition开始，自顶至底去填充ListView。而这个方法本身没有什么逻辑，就是判断一下mFirstPosition值的合法性，然后调用fillDown()方法，因此，填充ListView的操作是在fillDown()方法中完成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillDown</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> nextTop)</span> </span>&#123;</div><div class="line">        View selectedView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> end = (mBottom - mTop);</div><div class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">            end -= mListPadding.bottom;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (nextTop &lt; end &amp;&amp; pos &lt; mItemCount) &#123;</div><div class="line">            <span class="keyword">boolean</span> selected = pos == mSelectedPosition;</div><div class="line">            View child = makeAndAddView(pos, nextTop, <span class="keyword">true</span>, mListPadding.left, selected);</div><div class="line"></div><div class="line">            nextTop = child.getBottom() + mDividerHeight;</div><div class="line">            <span class="keyword">if</span> (selected) &#123;</div><div class="line">                selectedView = child;</div><div class="line">            &#125;</div><div class="line">            pos++;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setVisibleRangeHint(mFirstPosition, mFirstPosition + getChildCount() - <span class="number">1</span>);</div><div class="line">        <span class="keyword">return</span> selectedView;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到，这里使用了一个while循环来执行重复逻辑，一开始nextTop的值是第一个子元素顶部距离整个ListView顶部的像素值，pos则是刚刚传入的mFirstPosition的值，而end是ListView底部减去顶部所有的像素值，mItemCount则是Adapter中的元素数量。因此一开始的情况下nextTop必定是小于end的值，并且pos也是小于mItemCount的值的。那么每执行一次while循环，pos的值就会加1，并且nextTop也会增加，当nextTop大于等于end时，也就是子元素已经超出当前屏幕，或者pos大于等于mItemCount时，也就是所有Adapter中的元素都会被遍历结束了，就会跳出while循环。</p>
<p>在while循环中，最值得留意的方法就是makeAndAddView()方法了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">            <span class="keyword">boolean</span> selected) &#123;</div><div class="line">        <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">            <span class="keyword">final</span> View activeView = mRecycler.getActiveView(position);</div><div class="line">            <span class="keyword">if</span> (activeView != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">                setupChild(activeView, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> activeView;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> View child = obtainView(position, mIsScrap);</div><div class="line"></div><div class="line">        setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> child;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个方法一开始尝试从RecycleBin当中去快速获取一个active view，不过目前RecycleBin当中还没有缓存任何View，所以这里得到的值是null。得到null后会继续向下运行，调用obtainView()方法来再次尝试获取一个View，这个方法是可以保证一定返回一个View的，于是下面立刻将获取到的View传入到了setupChild()方法当中。先来看看obtainView()方法的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function">View <span class="title">obtainView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span>[] outMetadata)</span> </span>&#123;</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"obtainView"</span>);</div><div class="line">        outMetadata[<span class="number">0</span>] = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">final</span> View transientView = mRecycler.getTransientStateView(position);</div><div class="line">        <span class="keyword">if</span> (transientView != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> LayoutParams params = (LayoutParams) transientView.getLayoutParams();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (params.viewType == mAdapter.getItemViewType(position)) &#123;</div><div class="line">                <span class="keyword">final</span> View updatedView = mAdapter.getView(position, transientView, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (updatedView != transientView) &#123;</div><div class="line">                    setItemViewLayoutParams(updatedView, position);</div><div class="line">                    mRecycler.addScrapView(updatedView, position);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            outMetadata[<span class="number">0</span>] = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">            transientView.dispatchFinishTemporaryDetach();</div><div class="line">            <span class="keyword">return</span> transientView;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> View scrapView = mRecycler.getScrapView(position);</div><div class="line">        <span class="keyword">final</span> View child = mAdapter.getView(position, scrapView, <span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (scrapView != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (child != scrapView) &#123;</div><div class="line">                mRecycler.addScrapView(scrapView, position);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.isTemporarilyDetached()) &#123;</div><div class="line">                outMetadata[<span class="number">0</span>] = <span class="keyword">true</span>;</div><div class="line">                child.dispatchFinishTemporaryDetach();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mCacheColorHint != <span class="number">0</span>) &#123;</div><div class="line">            child.setDrawingCacheBackgroundColor(mCacheColorHint);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (child.getImportantForAccessibility() == IMPORTANT_FOR_ACCESSIBILITY_AUTO) &#123;</div><div class="line">            child.setImportantForAccessibility(IMPORTANT_FOR_ACCESSIBILITY_YES);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setItemViewLayoutParams(child, position);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (AccessibilityManager.getInstance(mContext).isEnabled()) &#123;</div><div class="line">            <span class="keyword">if</span> (mAccessibilityDelegate == <span class="keyword">null</span>) &#123;</div><div class="line">                mAccessibilityDelegate = <span class="keyword">new</span> ListItemAccessibilityDelegate();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (child.getAccessibilityDelegate() == <span class="keyword">null</span>) &#123;</div><div class="line">                child.setAccessibilityDelegate(mAccessibilityDelegate);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> child;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>obtainView()方法在第一次layout的时候会调用RecycleBin的getScrapView()方法来尝试获取一个废弃缓存中的View，这里会返回null，于是紧接着会调用mAdapter的getView()方法来获取一个View。这里mAdapter就是与ListView关联的适配器，而getView()方法就是我们最为熟悉的在适配器里面的的重载方法。getView()方法接受的三个参数，第一个参数position代表当前子元素的位置，可以通过具体的位置来获取与其相关的数据，第二个参数convertView，刚才传入的是null，说明没有convertView可以利用，因此我们会调用LayoutInflater的inflate()方法去加载一个布局，接下来就是对这个view进行一些属性和值的设定，最后将view返回。</p>
<p>这个View也会作为obtainView()的结果进行返回，并最终传入到setupChild()方法当中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupChild</span><span class="params">(View child, <span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flowDown, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">        <span class="keyword">boolean</span> selected, <span class="keyword">boolean</span> isAttachedToWindow) &#123;</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"setupListItem"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isSelected = selected &amp;&amp; shouldShowSelector();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> updateChildSelected = isSelected != child.isSelected();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mode = mTouchMode;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isPressed = mode &gt; TOUCH_MODE_DOWN &amp;&amp; mode &lt; TOUCH_MODE_SCROLL</div><div class="line">            &amp;&amp; mMotionPosition == position;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> updateChildPressed = isPressed != child.isPressed();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> needToMeasure = !isAttachedToWindow || updateChildSelected</div><div class="line">            || child.isLayoutRequested();</div><div class="line"></div><div class="line">    AbsListView.LayoutParams p = (AbsListView.LayoutParams) child.getLayoutParams();</div><div class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">        p = (AbsListView.LayoutParams) generateDefaultLayoutParams();</div><div class="line">    &#125;</div><div class="line">    p.viewType = mAdapter.getItemViewType(position);</div><div class="line">    p.isEnabled = mAdapter.isEnabled(position);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (updateChildSelected) &#123;</div><div class="line">        child.setSelected(isSelected);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (updateChildPressed) &#123;</div><div class="line">        child.setPressed(isPressed);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mChoiceMode != CHOICE_MODE_NONE &amp;&amp; mCheckStates != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (child <span class="keyword">instanceof</span> Checkable) &#123;</div><div class="line">            ((Checkable) child).setChecked(mCheckStates.get(position));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getContext().getApplicationInfo().targetSdkVersion</div><div class="line">                &gt;= android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">            child.setActivated(mCheckStates.get(position));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((isAttachedToWindow &amp;&amp; !p.forceAdd) || (p.recycledHeaderFooter</div><div class="line">            &amp;&amp; p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER)) &#123;</div><div class="line">        attachViewToParent(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (isAttachedToWindow</div><div class="line">                &amp;&amp; (((AbsListView.LayoutParams) child.getLayoutParams()).scrappedFromPosition)</div><div class="line">                        != position) &#123;</div><div class="line">            child.jumpDrawablesToCurrentState();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        p.forceAdd = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">            p.recycledHeaderFooter = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        addViewInLayout(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p, <span class="keyword">true</span>);</div><div class="line">        child.resolveRtlPropertiesIfNeeded();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childWidthSpec = ViewGroup.getChildMeasureSpec(mWidthMeasureSpec,</div><div class="line">                mListPadding.left + mListPadding.right, p.width);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> lpHeight = p.height;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childHeightSpec;</div><div class="line">        <span class="keyword">if</span> (lpHeight &gt; <span class="number">0</span>) &#123;</div><div class="line">            childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight, MeasureSpec.EXACTLY);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            childHeightSpec = MeasureSpec.makeSafeMeasureSpec(getMeasuredHeight(),</div><div class="line">                    MeasureSpec.UNSPECIFIED);</div><div class="line">        &#125;</div><div class="line">        child.measure(childWidthSpec, childHeightSpec);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        cleanupLayoutState(child);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> w = child.getMeasuredWidth();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> h = child.getMeasuredHeight();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childTop = flowDown ? y : y - h;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childRight = childrenLeft + w;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childBottom = childTop + h;</div><div class="line">        child.layout(childrenLeft, childTop, childRight, childBottom);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        child.offsetLeftAndRight(childrenLeft - child.getLeft());</div><div class="line">        child.offsetTopAndBottom(childTop - child.getTop());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mCachingStarted &amp;&amp; !child.isDrawingCacheEnabled()) &#123;</div><div class="line">        child.setDrawingCacheEnabled(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>setupChild()方法当中的代码虽然比较多，但是核心代码不多。刚才调用的obtainView()方法获取到的子元素View，最终会调用addViewInLayout()方法将它添加到ListView当中。</p>
<p>根据fillDown()方法中的while循环，会让子元素View将整个ListView控件填满后就跳出，也就是说即使Adapter中有一千多条数据，ListView也只会加载满第一屏的数据，剩下的数据目前在屏幕上看不到，所以不会去做多余的加载工作，这样就可以保证ListView中的内容能够迅速展示到屏幕上了。到此，ListView的第一次layout过程结束。</p>
<p>我们知道，<a href="http://blog.csdn.net/u012422440/article/details/52972825" target="_blank" rel="external">View初始化时会measure三次，layout两次，draw一次</a>，这是一个很小的细节，平时影响并不大，因为不管测量布局几次，都是执行相同的逻辑，所以并不予以过多关心。但是在ListView中情况就不一样了，因为这意味着layouChildren()过程会执行两次，而这个过程当涉及向ListView中添加子元素，如果相同的逻辑执行两遍的话，ListView中就会存在一份重复的数据了。因此ListView在layoutChildren()过程中做了第二次layout的逻辑处理，巧妙地解决了这个问题。下面开始分析第二次layout的过程。</p>
<p>ListView第二次layout过程中，调用getChildCount()方法来获取子View的数量，这一次得到的值不再为0，而是ListView中一屏可以显示的子View数量。紧接着调用RecycleBin的fillActiveViews()方法，因为目前ListView中已经有子View了，这样所有的子View都会被缓存到RecycleBin的mActiveViews数组当中。接着是一个非常重要的操作，即调用detachAllViewsFromParent()方法将所有ListView中的子View清除掉，从而保证第二次layout过程不会产生一份重复的数据，因为之前调用了RecycleBin的fillActiveViews()方法来缓存子View，所以第二次重新加载直接使用这些缓存好的View就可以了，并不会重新执行一次inflate过程，因此效率方面并不会有明显的影响。</p>
<p>第二次layout过程中，由于getChildCount()不为0，所以取代fillDown()或fillUp()方法的是fillSpecific()方法，这个方法与前两个的功能也是差不多的，主要区别在于，fillSpecial()方法会优先将指定位置的子View先加载到屏幕上，然后再加载该子View往上以及往下的其它子View。这里不再去关注太多细节，而是将精力放回makeAndAddView()方法来。makeAndAddView()方法仍然尝试从RecycleBin当中获取Active View，然而这次就可以取到了，所以就不用进入obtainView()方法，而是直接进入setupChild()方法当中，这样也会节省了很多时间，提高了效率。setupChild()方法也不再调用addViewInLayout()方法，而是改调用attachViewToParent()方法将在前面被detachAllViewsFromParent()方法置为detach状态的子View重新变为attach状态的，最终ListView中所有的子View又都可以正常显示出来了，至此ListView的第二次layout就结束了。</p>
<h4 id="ListView滑动加载更多数据工作原理"><a href="#ListView滑动加载更多数据工作原理" class="headerlink" title="ListView滑动加载更多数据工作原理"></a>ListView滑动加载更多数据工作原理</h4><p>经过前面分析的两次layout过程，我们已经可以在ListView中看到内容了，但是目前ListView中只是加载并显示了第一屏的数据而已。因此，接下来就要看一下ListView滑动部分的源码了，因为我们是通过手指滑动来显示更多数据的。</p>
<p>由于滑动部分的机制是属于通用型的，即ListView和GridView都会使用同样的机制，因此这部分代码是写在AbsListView当中的，所以接下来看一下AbsListView中监听触控事件的onTouchEvent()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isEnabled()) &#123;</div><div class="line">            <span class="keyword">return</span> isClickable() || isLongClickable();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mPositionScroller != <span class="keyword">null</span>) &#123;</div><div class="line">            mPositionScroller.stop();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mIsDetaching || !isAttachedToWindow()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        startNestedScroll(SCROLL_AXIS_VERTICAL);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span> &amp;&amp; mFastScroll.onTouchEvent(ev)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        initVelocityTrackerIfNotExists();</div><div class="line">        <span class="keyword">final</span> MotionEvent vtev = MotionEvent.obtain(ev);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = ev.getActionMasked();</div><div class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">            mNestedYOffset = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        vtev.offsetLocation(<span class="number">0</span>, mNestedYOffset);</div><div class="line">        <span class="keyword">switch</span> (actionMasked) &#123;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">                onTouchDown(ev);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">                onTouchMove(ev, vtev);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</div><div class="line">                onTouchUp(ev);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</div><div class="line">                onTouchCancel();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP: &#123;</div><div class="line">                onSecondaryPointerUp(ev);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> x = mMotionX;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> y = mMotionY;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> motionPosition = pointToPosition(x, y);</div><div class="line">                <span class="keyword">if</span> (motionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> View child = getChildAt(motionPosition - mFirstPosition);</div><div class="line">                    mMotionViewOriginalTop = child.getTop();</div><div class="line">                    mMotionPosition = motionPosition;</div><div class="line">                &#125;</div><div class="line">                mLastY = y;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN: &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = ev.getActionIndex();</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> id = ev.getPointerId(index);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> x = (<span class="keyword">int</span>) ev.getX(index);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY(index);</div><div class="line">                mMotionCorrection = <span class="number">0</span>;</div><div class="line">                mActivePointerId = id;</div><div class="line">                mMotionX = x;</div><div class="line">                mMotionY = y;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> motionPosition = pointToPosition(x, y);</div><div class="line">                <span class="keyword">if</span> (motionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> View child = getChildAt(motionPosition - mFirstPosition);</div><div class="line">                    mMotionViewOriginalTop = child.getTop();</div><div class="line">                    mMotionPosition = motionPosition;</div><div class="line">                &#125;</div><div class="line">                mLastY = y;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mVelocityTracker != <span class="keyword">null</span>) &#123;</div><div class="line">            mVelocityTracker.addMovement(vtev);</div><div class="line">        &#125;</div><div class="line">        vtev.recycle();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>因为目前所关心的就只有手指在屏幕上滑动这一事件而已，所以这里只需要关注ACTION_MOVE这个动作。ACTION_MOVE这个case里面调用了onTouchMove()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onTouchMove</span><span class="params">(MotionEvent ev, MotionEvent vtev)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mHasPerformedLongPress) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> pointerIndex = ev.findPointerIndex(mActivePointerId);</div><div class="line">        <span class="keyword">if</span> (pointerIndex == -<span class="number">1</span>) &#123;</div><div class="line">            pointerIndex = <span class="number">0</span>;</div><div class="line">            mActivePointerId = ev.getPointerId(pointerIndex);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mDataChanged) &#123;</div><div class="line">            layoutChildren();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY(pointerIndex);</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (mTouchMode) &#123;</div><div class="line">            <span class="keyword">case</span> TOUCH_MODE_DOWN:</div><div class="line">            <span class="keyword">case</span> TOUCH_MODE_TAP:</div><div class="line">            <span class="keyword">case</span> TOUCH_MODE_DONE_WAITING:</div><div class="line">                <span class="keyword">if</span> (startScrollIfNeeded((<span class="keyword">int</span>) ev.getX(pointerIndex), y, vtev)) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">final</span> View motionView = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(pointerIndex);</div><div class="line">                <span class="keyword">if</span> (!pointInView(x, y, mTouchSlop)) &#123;</div><div class="line">                    setPressed(<span class="keyword">false</span>);</div><div class="line">                    <span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">                        motionView.setPressed(<span class="keyword">false</span>);</div><div class="line">                    &#125;</div><div class="line">                    removeCallbacks(mTouchMode == TOUCH_MODE_DOWN ?</div><div class="line">                            mPendingCheckForTap : mPendingCheckForLongPress);</div><div class="line">                    mTouchMode = TOUCH_MODE_DONE_WAITING;</div><div class="line">                    updateSelectorState();</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span>[] point = mTmpPoint;</div><div class="line">                    point[<span class="number">0</span>] = x;</div><div class="line">                    point[<span class="number">1</span>] = y;</div><div class="line">                    transformPointToViewLocal(point, motionView);</div><div class="line">                    motionView.drawableHotspotChanged(point[<span class="number">0</span>], point[<span class="number">1</span>]);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TOUCH_MODE_SCROLL:</div><div class="line">            <span class="keyword">case</span> TOUCH_MODE_OVERSCROLL:</div><div class="line">                scrollIfNeeded((<span class="keyword">int</span>) ev.getX(pointerIndex), y, vtev);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>当手指在屏幕上滑动的时候，又会进入TOUCH_MODE_SCROLL这个动作，这个动作下又会调用scrollIfNeeded()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scrollIfNeeded</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, MotionEvent vtev)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> rawDeltaY = y - mMotionY;</div><div class="line">        <span class="keyword">int</span> scrollOffsetCorrection = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> scrollConsumedCorrection = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (mLastY == Integer.MIN_VALUE) &#123;</div><div class="line">            rawDeltaY -= mMotionCorrection;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (dispatchNestedPreScroll(<span class="number">0</span>, mLastY != Integer.MIN_VALUE ? mLastY - y : -rawDeltaY,</div><div class="line">                mScrollConsumed, mScrollOffset)) &#123;</div><div class="line">            rawDeltaY += mScrollConsumed[<span class="number">1</span>];</div><div class="line">            scrollOffsetCorrection = -mScrollOffset[<span class="number">1</span>];</div><div class="line">            scrollConsumedCorrection = mScrollConsumed[<span class="number">1</span>];</div><div class="line">            <span class="keyword">if</span> (vtev != <span class="keyword">null</span>) &#123;</div><div class="line">                vtev.offsetLocation(<span class="number">0</span>, mScrollOffset[<span class="number">1</span>]);</div><div class="line">                mNestedYOffset += mScrollOffset[<span class="number">1</span>];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> deltaY = rawDeltaY;</div><div class="line">        <span class="keyword">int</span> incrementalDeltaY =</div><div class="line">                mLastY != Integer.MIN_VALUE ? y - mLastY + scrollConsumedCorrection : deltaY;</div><div class="line">        <span class="keyword">int</span> lastYCorrection = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mTouchMode == TOUCH_MODE_SCROLL) &#123;</div><div class="line">            <span class="keyword">if</span> (PROFILE_SCROLLING) &#123;</div><div class="line">                <span class="keyword">if</span> (!mScrollProfilingStarted) &#123;</div><div class="line">                    Debug.startMethodTracing(<span class="string">"AbsListViewScroll"</span>);</div><div class="line">                    mScrollProfilingStarted = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mScrollStrictSpan == <span class="keyword">null</span>) &#123;</div><div class="line">                mScrollStrictSpan = StrictMode.enterCriticalSpan(<span class="string">"AbsListView-scroll"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (y != mLastY) &#123;</div><div class="line">                <span class="keyword">if</span> ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) == <span class="number">0</span> &amp;&amp;</div><div class="line">                        Math.abs(rawDeltaY) &gt; mTouchSlop) &#123;</div><div class="line">                    <span class="keyword">final</span> ViewParent parent = getParent();</div><div class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">                        parent.requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> motionIndex;</div><div class="line">                <span class="keyword">if</span> (mMotionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    motionIndex = mMotionPosition - mFirstPosition;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    motionIndex = getChildCount() / <span class="number">2</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">int</span> motionViewPrevTop = <span class="number">0</span>;</div><div class="line">                View motionView = <span class="keyword">this</span>.getChildAt(motionIndex);</div><div class="line">                <span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">                    motionViewPrevTop = motionView.getTop();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">boolean</span> atEdge = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (incrementalDeltaY != <span class="number">0</span>) &#123;</div><div class="line">                    atEdge = trackMotionScroll(deltaY, incrementalDeltaY);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                motionView = <span class="keyword">this</span>.getChildAt(motionIndex);</div><div class="line">                <span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> motionViewRealTop = motionView.getTop();</div><div class="line">                    <span class="keyword">if</span> (atEdge) &#123;</div><div class="line">                        <span class="keyword">int</span> overscroll = -incrementalDeltaY -</div><div class="line">                                (motionViewRealTop - motionViewPrevTop);</div><div class="line">                        <span class="keyword">if</span> (dispatchNestedScroll(<span class="number">0</span>, overscroll - incrementalDeltaY, <span class="number">0</span>, overscroll,</div><div class="line">                                mScrollOffset)) &#123;</div><div class="line">                            lastYCorrection -= mScrollOffset[<span class="number">1</span>];</div><div class="line">                            <span class="keyword">if</span> (vtev != <span class="keyword">null</span>) &#123;</div><div class="line">                                vtev.offsetLocation(<span class="number">0</span>, mScrollOffset[<span class="number">1</span>]);</div><div class="line">                                mNestedYOffset += mScrollOffset[<span class="number">1</span>];</div><div class="line">                            &#125;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            <span class="keyword">final</span> <span class="keyword">boolean</span> atOverscrollEdge = overScrollBy(<span class="number">0</span>, overscroll,</div><div class="line">                                    <span class="number">0</span>, mScrollY, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, mOverscrollDistance, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">                            <span class="keyword">if</span> (atOverscrollEdge &amp;&amp; mVelocityTracker != <span class="keyword">null</span>) &#123;</div><div class="line">                                mVelocityTracker.clear();</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            <span class="keyword">final</span> <span class="keyword">int</span> overscrollMode = getOverScrollMode();</div><div class="line">                            <span class="keyword">if</span> (overscrollMode == OVER_SCROLL_ALWAYS ||</div><div class="line">                                    (overscrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp;</div><div class="line">                                            !contentFits())) &#123;</div><div class="line">                                <span class="keyword">if</span> (!atOverscrollEdge) &#123;</div><div class="line">                                    mDirection = <span class="number">0</span>;</div><div class="line">                                    mTouchMode = TOUCH_MODE_OVERSCROLL;</div><div class="line">                                &#125;</div><div class="line">                                <span class="keyword">if</span> (incrementalDeltaY &gt; <span class="number">0</span>) &#123;</div><div class="line">                                    mEdgeGlowTop.onPull((<span class="keyword">float</span>) -overscroll / getHeight(),</div><div class="line">                                            (<span class="keyword">float</span>) x / getWidth());</div><div class="line">                                    <span class="keyword">if</span> (!mEdgeGlowBottom.isFinished()) &#123;</div><div class="line">                                        mEdgeGlowBottom.onRelease();</div><div class="line">                                    &#125;</div><div class="line">                                    invalidateTopGlow();</div><div class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">                                    mEdgeGlowBottom.onPull((<span class="keyword">float</span>) overscroll / getHeight(),</div><div class="line">                                            <span class="number">1</span>.f - (<span class="keyword">float</span>) x / getWidth());</div><div class="line">                                    <span class="keyword">if</span> (!mEdgeGlowTop.isFinished()) &#123;</div><div class="line">                                        mEdgeGlowTop.onRelease();</div><div class="line">                                    &#125;</div><div class="line">                                    invalidateBottomGlow();</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    mMotionY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">                &#125;</div><div class="line">                mLastY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mTouchMode == TOUCH_MODE_OVERSCROLL) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>scrollIfNeeded()这个方法通过计算incrementalDeltaY的正负情况来判断用户是向上还是向下滑动的（如果小于0标识向下滑动，否则就是向上滑动），并且会进行边界值检测的过程，主要是通过调用trackMotionScroll()这个方法来实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">trackMotionScroll</span><span class="params">(<span class="keyword">int</span> deltaY, <span class="keyword">int</span> incrementalDeltaY)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">        <span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> firstTop = getChildAt(<span class="number">0</span>).getTop();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> lastBottom = getChildAt(childCount - <span class="number">1</span>).getBottom();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Rect listPadding = mListPadding;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> effectivePaddingTop = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> effectivePaddingBottom = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">            effectivePaddingTop = listPadding.top;</div><div class="line">            effectivePaddingBottom = listPadding.bottom;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> spaceAbove = effectivePaddingTop - firstTop;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> end = getHeight() - effectivePaddingBottom;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> spaceBelow = lastBottom - end;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> height = getHeight() - mPaddingBottom - mPaddingTop;</div><div class="line">        <span class="keyword">if</span> (deltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">            deltaY = Math.max(-(height - <span class="number">1</span>), deltaY);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            deltaY = Math.min(height - <span class="number">1</span>, deltaY);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">            incrementalDeltaY = Math.max(-(height - <span class="number">1</span>), incrementalDeltaY);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            incrementalDeltaY = Math.min(height - <span class="number">1</span>, incrementalDeltaY);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (firstPosition == <span class="number">0</span>) &#123;</div><div class="line">            mFirstPositionDistanceGuess = firstTop - listPadding.top;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mFirstPositionDistanceGuess += incrementalDeltaY;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (firstPosition + childCount == mItemCount) &#123;</div><div class="line">            mLastPositionDistanceGuess = lastBottom + listPadding.bottom;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mLastPositionDistanceGuess += incrementalDeltaY;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> cannotScrollDown = (firstPosition == <span class="number">0</span> &amp;&amp;</div><div class="line">                firstTop &gt;= listPadding.top &amp;&amp; incrementalDeltaY &gt;= <span class="number">0</span>);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> cannotScrollUp = (firstPosition + childCount == mItemCount &amp;&amp;</div><div class="line">                lastBottom &lt;= getHeight() - listPadding.bottom &amp;&amp; incrementalDeltaY &lt;= <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (cannotScrollDown || cannotScrollUp) &#123;</div><div class="line">            <span class="keyword">return</span> incrementalDeltaY != <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> down = incrementalDeltaY &lt; <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> inTouchMode = isInTouchMode();</div><div class="line">        <span class="keyword">if</span> (inTouchMode) &#123;</div><div class="line">            hideSelector();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> headerViewsCount = getHeaderViewsCount();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> footerViewsStart = mItemCount - getFooterViewsCount();</div><div class="line"></div><div class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (down) &#123;</div><div class="line">            <span class="keyword">int</span> top = -incrementalDeltaY;</div><div class="line">            <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">                top += listPadding.top;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">                <span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">                <span class="keyword">if</span> (child.getBottom() &gt;= top) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    count++;</div><div class="line">                    <span class="keyword">int</span> position = firstPosition + i;</div><div class="line">                    <span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) &#123;</div><div class="line">                        child.clearAccessibilityFocus();</div><div class="line">                        mRecycler.addScrapView(child, position);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">int</span> bottom = getHeight() - incrementalDeltaY;</div><div class="line">            <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">                bottom -= listPadding.bottom;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                <span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">                <span class="keyword">if</span> (child.getTop() &lt;= bottom) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    start = i;</div><div class="line">                    count++;</div><div class="line">                    <span class="keyword">int</span> position = firstPosition + i;</div><div class="line">                    <span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) &#123;</div><div class="line">                        child.clearAccessibilityFocus();</div><div class="line">                        mRecycler.addScrapView(child, position);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mMotionViewNewTop = mMotionViewOriginalTop + deltaY;</div><div class="line"></div><div class="line">        mBlockLayoutRequests = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</div><div class="line">            detachViewsFromParent(start, count);</div><div class="line">            mRecycler.removeSkippedScrap();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!awakenScrollBars()) &#123;</div><div class="line">           invalidate();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        offsetChildrenTopAndBottom(incrementalDeltaY);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (down) &#123;</div><div class="line">            mFirstPosition += count;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> absIncrementalDeltaY = Math.abs(incrementalDeltaY);</div><div class="line">        <span class="keyword">if</span> (spaceAbove &lt; absIncrementalDeltaY || spaceBelow &lt; absIncrementalDeltaY) &#123;</div><div class="line">            fillGap(down);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mRecycler.fullyDetachScrapViews();</div><div class="line">        <span class="keyword">if</span> (!inTouchMode &amp;&amp; mSelectedPosition != INVALID_POSITION) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childIndex = mSelectedPosition - mFirstPosition;</div><div class="line">            <span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) &#123;</div><div class="line">                positionSelector(mSelectedPosition, getChildAt(childIndex));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childIndex = mSelectorPosition - mFirstPosition;</div><div class="line">            <span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) &#123;</div><div class="line">                positionSelector(INVALID_POSITION, getChildAt(childIndex));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mSelectorRect.setEmpty();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mBlockLayoutRequests = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        invokeOnItemScrollListener();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个方法会在ListView向下滑动的时候，进入一个for循环，从上到下一次获取子View，如果该子View的bottom已经小于top值了，就说明这个子View已经移出屏幕了，所以会调用RecycleBin的addScrapView()方法将这个View加入到废弃缓存当中，并将count计数器加1，计数器用于记录有多少个子View被移出了屏幕。之后会根据计算器的值来进行一次detach操作。紧接着调用offsetChildrenTopAndBottom()并将incrementalDeltaY作为参数传入，这个方法让ListView中所有的子View都按照传入的参数值进行相对的偏移，这样就实现了随着手指的拖动，ListView的内容也会随着滚动的效果。如果ListView中最后一个View的底部已经移入了屏幕，或者第一个View的顶部移入了屏幕，就会调用fillGap()方法用来加载屏幕外的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">fillGap</span><span class="params">(<span class="keyword">boolean</span> down)</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line">       <span class="keyword">if</span> (down) &#123;</div><div class="line">           <span class="keyword">int</span> paddingTop = <span class="number">0</span>;</div><div class="line">           <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">               paddingTop = getListPaddingTop();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(count - <span class="number">1</span>).getBottom() + mDividerHeight :</div><div class="line">                   paddingTop;</div><div class="line">           fillDown(mFirstPosition + count, startOffset);</div><div class="line">           correctTooHigh(getChildCount());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">int</span> paddingBottom = <span class="number">0</span>;</div><div class="line">           <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">               paddingBottom = getListPaddingBottom();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(<span class="number">0</span>).getTop() - mDividerHeight :</div><div class="line">                   getHeight() - paddingBottom;</div><div class="line">           fillUp(mFirstPosition - <span class="number">1</span>, startOffset);</div><div class="line">           correctTooLow(getChildCount());</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>fillGap()这个方法通过down参数判断ListView是向下滑动还是向上滑动，并相应调用fillDown()或fillUp()方法。这两个方法前面已经分析过，内部是通过循环对ListView进行填充，循环的主要逻辑就是makeAndAddView()方法，这时候这个方法会调用RecycleBin的getScrapView()方法从废弃缓存中获取一个View。</p>
<p>这样它们之间就形成了一个生产者和消费者的模式，不管有任意多条数据需要显示，ListView中的子View其实来来回回就那么几个，移出屏幕的子View会很快被移如屏幕的数据重新利用起来，因此不管我们加载多少数据都不会出现OOM的情况，甚至内存都不会有所增加。</p>
<p>最后附上一张图来总结一下ListView滑动加载数据的工作原理。</p>
<p><img src="http://img.blog.csdn.net/20150719213754421?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android基础篇/" rel="tag"># android基础篇</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/18/Java集合框架（三）/" rel="next" title="Java集合框架——Iterator接口">
                <i class="fa fa-chevron-left"></i> Java集合框架——Iterator接口
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/20/深入理解ListView工作原理（二）/" rel="prev" title="深入理解ListView工作原理（二）">
                深入理解ListView工作原理（二） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/icon.jpg"
                alt="sufushi" />
            
              <p class="site-author-name" itemprop="name">sufushi</p>
              <p class="site-description motion-element" itemprop="description">这是苏富仕的博客</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/sufushi" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Adapter的作用"><span class="nav-number">2.</span> <span class="nav-text">Adapter的作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RecyclerBin机制"><span class="nav-number">3.</span> <span class="nav-text">RecyclerBin机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ListView的布局工作原理"><span class="nav-number">4.</span> <span class="nav-text">ListView的布局工作原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ListView滑动加载更多数据工作原理"><span class="nav-number">5.</span> <span class="nav-text">ListView滑动加载更多数据工作原理</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sufushi</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.3"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.3"></script>


  

</body>
</html>
