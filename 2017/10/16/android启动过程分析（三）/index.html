<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="android framework," />










<meta name="description" content="概要
从字面上看，zygote是“受精卵”的意思。zygote是android系统应用中一个相当重要的进程，它的主要功能是执行android应用程序。在android系统中运行新的应用，如同受精分裂一样，需要跟zygote进程（拥有应用程序运行时所需要的各种元素与条件）结合后才能执行。

zygote进程运行时，会初始化Dalvik虚拟机，并启动它。android的应用程序是由Java编写的，它们">
<meta property="og:type" content="article">
<meta property="og:title" content="android启动过程分析——zygote进程">
<meta property="og:url" content="sufushi.github.io/2017/10/16/android启动过程分析（三）/index.html">
<meta property="og:site_name" content="苏富仕的博客">
<meta property="og:description" content="概要
从字面上看，zygote是“受精卵”的意思。zygote是android系统应用中一个相当重要的进程，它的主要功能是执行android应用程序。在android系统中运行新的应用，如同受精分裂一样，需要跟zygote进程（拥有应用程序运行时所需要的各种元素与条件）结合后才能执行。

zygote进程运行时，会初始化Dalvik虚拟机，并启动它。android的应用程序是由Java编写的，它们">
<meta property="og:image" content="http://oxsxuoiqx.bkt.clouddn.com/zygote%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6.png">
<meta property="og:updated_time" content="2018-01-16T03:37:36.704Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android启动过程分析——zygote进程">
<meta name="twitter:description" content="概要
从字面上看，zygote是“受精卵”的意思。zygote是android系统应用中一个相当重要的进程，它的主要功能是执行android应用程序。在android系统中运行新的应用，如同受精分裂一样，需要跟zygote进程（拥有应用程序运行时所需要的各种元素与条件）结合后才能执行。

zygote进程运行时，会初始化Dalvik虚拟机，并启动它。android的应用程序是由Java编写的，它们">
<meta name="twitter:image" content="http://oxsxuoiqx.bkt.clouddn.com/zygote%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="sufushi.github.io/2017/10/16/android启动过程分析（三）/"/>





  <title>android启动过程分析——zygote进程 | 苏富仕的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">苏富仕的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">-4</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="sufushi.github.io/2017/10/16/android启动过程分析（三）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sufushi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏富仕的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">android启动过程分析——zygote进程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-16T20:01:31+08:00">
                2017-10-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h4><ul>
<li><p>从字面上看，zygote是“受精卵”的意思。zygote是android系统应用中一个相当重要的进程，它的主要功能是执行android应用程序。在android系统中运行新的应用，如同受精分裂一样，需要跟zygote进程（拥有应用程序运行时所需要的各种元素与条件）结合后才能执行。</p>
</li>
<li><p>zygote进程运行时，会初始化Dalvik虚拟机，并启动它。android的应用程序是由Java编写的，它们不能直接以本地进程的形态运行在Linux上，只能运行在Dalvik虚拟机中。并且，每个应用程序都运行在各自的虚拟机中，应用程序每次运行都要重新初始化并启动虚拟机，这个过程会耗费相当长时间，是拖慢应用程序的原因之一。因此，在android中，应用程序运行前，zygote进程通过共享已运行的虚拟机的代码和内存信息，缩短应用程序运行所耗费的时间。并且，它会事先将应用程序要使用的android framework中的类和资源加载到内存中，并组织所使用资源的链接信息，这就会节省大量时间，提高程序运行速度。</p>
</li>
<li><p>在android系统中有以下两种进程：</p>
<ul>
<li>Java应用程序，主要基于ART虚拟机，所有的应用程序apk都属于这类。</li>
<li>native程序，也就是使用C和C++语言开发的 程序，比如bootanimation。</li>
</ul>
<p>所有的Java应用程序进程以及系统服务SystemServer进程都是由zygote进程通过Linux的fork()函数孵化出来，而native进程则由init进程创建启动。zygote进程最初的名字是app_process，但是zygote进程在启动的过程中，通过Linux下的pctrl系统调用换成了zygote。</p>
</li>
<li><p>zygote是一个C/S模型，zygote进程作为服务端，其他进程作为一个客户端向它发出“孵化”请求，而zygote接收这个请求之后就会“孵化”出一个新的进程。如下图，当Launcher里的应用程序图标去启动一个新的应用程序进程时，这个请求会到达框架层的核心服务ActivityManagerService中，当ActivityManagerService收到这个请求之后，会通过调用Process类发送一个“孵化”子进程的Socket请求，而zygote监听到了这个请求之后就会立刻fork一个新的进程出来。</p>
<p><img src="http://oxsxuoiqx.bkt.clouddn.com/zygote%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6.png" alt="zygote孵化框架"></p>
</li>
</ul>
<h4 id="zygote进程的启动"><a href="#zygote进程的启动" class="headerlink" title="zygote进程的启动"></a>zygote进程的启动</h4><ul>
<li><p>zygote本身是一个native的应用程序，它被init进程启动起来，在init.rc文件中的配置如下：</p>
<p>service zygote /system/bin/app_process64 -Xzygote /system/bin –zygote –start-system-server</p>
<p>class main</p>
<p>socket zygote stream 660 root system</p>
<p>onrestart write /sys/android_power/request_state wake</p>
<p>onrestart write /sys/power/state on</p>
<p>onrestart  restart media</p>
<p>onrestart  restart netd</p>
<p>第一行代码的意思是，这个native service的名字为zygote，它的可执行程序是 /system/bin/app_process64。</p>
<p>第二行的关键字class为main，表示service的类型是main。</p>
<p>第三行的关键字socket，表示zygote进程会创建一个名称为zygote的socket，通过adb可以在/dev/socket目录下看到这个名为zygote的文件。这里定义的socket的类型是UNIX domain Socket，用作进程间通信，当启动一个新的应用程序时，系统框架中服务ActivityManagerService会调用Process类，Process类通过这个socket来和zygote进程通信，请求zygote进程fork一个应用程序。</p>
<p>最后几行关键字onrestart，表示这个zygote进程重启时需要执行的命令。</p>
</li>
<li><p>zygote进程对应的主文件为app_main.cpp，当它被init进程启动起来之后，就会进入主文件app_main.cpp的main()函数。</p>
<p>int main(int argc, char* const argv[])<br>{</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line">if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0) &lt; 0) &#123;</div><div class="line">    if (errno != EINVAL) &#123;</div><div class="line">        LOG_ALWAYS_FATAL("PR_SET_NO_NEW_PRIVS failed: %s", strerror(errno));</div><div class="line">        return 12;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));</div><div class="line">argc--;</div><div class="line">argv++;</div><div class="line"></div><div class="line">int i;</div><div class="line">for (i = 0; i &lt; argc; i++) &#123;</div><div class="line">    if (argv[i][0] != '-') &#123;</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">    if (argv[i][1] == '-' &amp;&amp; argv[i][2] == 0) &#123;</div><div class="line">        ++i; // Skip --.</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">    runtime.addOption(strdup(argv[i]));</div><div class="line">&#125;</div><div class="line"></div><div class="line">bool zygote = false;</div><div class="line">bool startSystemServer = false;</div><div class="line">bool application = false;</div><div class="line">String8 niceName;</div><div class="line">String8 className;</div><div class="line"></div><div class="line">++i; </div><div class="line">while (i &lt; argc) &#123;</div><div class="line">    const char* arg = argv[i++];</div><div class="line">    if (strcmp(arg, "--zygote") == 0) &#123;</div><div class="line">        zygote = true;</div><div class="line">        niceName = ZYGOTE_NICE_NAME; // ZYGOTE_NICE_NAME就是“zygote”,此处已换名字</div><div class="line">    &#125; else if (strcmp(arg, "--start-system-server") == 0) &#123;</div><div class="line">        startSystemServer = true; // 在init.rc里配置了前面这些参数，而zygote进程在启动的时候，init进程会传过来这些参数，所以此处把startSystemServer设置为true，代表SystemServer。</div><div class="line">    &#125; else if (strcmp(arg, "--application") == 0) &#123;</div><div class="line">        application = true;</div><div class="line">    &#125; else if (strncmp(arg, "--nice-name=", 12) == 0) &#123;</div><div class="line">        niceName.setTo(arg + 12);</div><div class="line">    &#125; else if (strncmp(arg, "--", 2) != 0) &#123;</div><div class="line">        className.setTo(arg);</div><div class="line">        break;</div><div class="line">    &#125; else &#123;</div><div class="line">        --i;</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Vector&lt;String8&gt; args;</div><div class="line">if (!className.isEmpty()) &#123;</div><div class="line">    args.add(application ? String8("application") : String8("tool"));</div><div class="line">    runtime.setClassNameAndArgs(className, argc - i, argv + i);</div><div class="line">&#125; else &#123;</div><div class="line">    maybeCreateDalvikCache();</div><div class="line"></div><div class="line">    if (startSystemServer) &#123;</div><div class="line">        args.add(String8("start-system-server"));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    char prop[PROP_VALUE_MAX];</div><div class="line">    if (property_get(ABI_LIST_PROPERTY, prop, NULL) == 0) &#123;</div><div class="line">        LOG_ALWAYS_FATAL("app_process: Unable to determine ABI list from property %s.",</div><div class="line">            ABI_LIST_PROPERTY);</div><div class="line">        return 11;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String8 abiFlag("--abi-list=");</div><div class="line">    abiFlag.append(prop);</div><div class="line">    args.add(abiFlag);</div><div class="line"></div><div class="line">    for (; i &lt; argc; ++i) &#123;</div><div class="line">        args.add(String8(argv[i]));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">if (!niceName.isEmpty()) &#123;</div><div class="line">    runtime.setArgv0(niceName.string());</div><div class="line">    // 此处调用set_process_name()函数，通过Linux下的pctrl系统调用把名字“app_process”换成了“zygote”</div><div class="line">    set_process_name(niceName.string());  </div><div class="line">&#125;</div><div class="line"></div><div class="line">if (zygote) &#123;</div><div class="line">    // zygote为true代表的是zygote进程，也就是谁现在正在启动zygote进程。因为zygote进程是通过自己的资源复制一份来fork一个新的子进程的，也就是说子进程也会进入这个文件的main函数，所以通过这个zygote变量就可以来区分</div><div class="line">    runtime.start("com.android.internal.os.ZygoteInit", args, zygote);</div><div class="line">&#125; else if (className) &#123;</div><div class="line">    runtime.start("com.android.internal.os.RuntimeInit", args, zygote);</div><div class="line">&#125; else &#123;</div><div class="line">    fprintf(stderr, "Error: no class name or --zygote supplied.\n");</div><div class="line">    app_usage();</div><div class="line">    LOG_ALWAYS_FATAL("app_process: no class name or --zygote supplied.");</div><div class="line">    return 10;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>}</p>
<p>可以看到main()函数最后会调用runtime的start()函数，runtime是一个AppRuntime对象，AppRuntime类继承AndroidRuntime的start()函数。</p>
<p>void AndroidRuntime::start(const char* className, const Vector<string8>&amp; options, bool zygote)<br>{</string8></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">ALOGD(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\n"</span>,</div><div class="line">        className != <span class="literal">NULL</span> ? className : <span class="string">"(unknown)"</span>, getuid());</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> String8 <span class="title">startSystemServer</span><span class="params">(<span class="string">"start-system-server"</span>)</span></span>;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</div><div class="line">    <span class="keyword">if</span> (options[i] == startSystemServer) &#123;</div><div class="line">       <span class="keyword">const</span> <span class="keyword">int</span> LOG_BOOT_PROGRESS_START = <span class="number">3000</span>;</div><div class="line">       LOG_EVENT_LONG(LOG_BOOT_PROGRESS_START,  ns2ms(systemTime(SYSTEM_TIME_MONOTONIC)));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span>* rootDir = getenv(<span class="string">"ANDROID_ROOT"</span>);</div><div class="line"><span class="keyword">if</span> (rootDir == <span class="literal">NULL</span>) &#123;</div><div class="line">    rootDir = <span class="string">"/system"</span>;</div><div class="line">    <span class="keyword">if</span> (!hasDir(<span class="string">"/system"</span>)) &#123;</div><div class="line">        LOG_FATAL(<span class="string">"No root directory specified, and /android does not exist."</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    setenv(<span class="string">"ANDROID_ROOT"</span>, rootDir, <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">JniInvocation jni_invocation;</div><div class="line">jni_invocation.Init(<span class="literal">NULL</span>);</div><div class="line">JNIEnv* env;</div><div class="line"><span class="comment">// 启动虚拟机</span></div><div class="line"><span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line">onVmCreated(env);</div><div class="line"><span class="comment">// 注册JNI函数</span></div><div class="line"><span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</div><div class="line">    ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">jclass stringClass;</div><div class="line">jobjectArray strArray;</div><div class="line">jstring classNameStr;</div><div class="line"></div><div class="line">stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</div><div class="line">assert(stringClass != <span class="literal">NULL</span>);</div><div class="line">strArray = env-&gt;NewObjectArray(options.size() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</div><div class="line">assert(strArray != <span class="literal">NULL</span>);</div><div class="line">classNameStr = env-&gt;NewStringUTF(className);</div><div class="line">assert(classNameStr != <span class="literal">NULL</span>);</div><div class="line">env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</div><div class="line">    jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="built_in">string</span>());</div><div class="line">    assert(optionsStr != <span class="literal">NULL</span>);</div><div class="line">    env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">char</span>* slashClassName = toSlashClassName(className);</div><div class="line">jclass startClass = env-&gt;FindClass(slashClassName);</div><div class="line"><span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</div><div class="line">    ALOGE(<span class="string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// 调用类的main方法</span></div><div class="line">    jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</div><div class="line">        <span class="string">"([Ljava/lang/String;)V"</span>);</div><div class="line">    <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</div><div class="line">        ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 调用ZygoteInit的main函数</span></div><div class="line">        env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></div><div class="line">    <span class="keyword">if</span> (env-&gt;ExceptionCheck())</div><div class="line">                threadExitUncaughtException(env);         </div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="built_in">free</span>(slashClassName);</div><div class="line"></div><div class="line">ALOGD(<span class="string">"Shutting down VM\n"</span>);</div><div class="line"><span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</div><div class="line">    ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</div><div class="line"><span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</div><div class="line">    ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</div></pre></td></tr></table></figure>
<p>}</p>
<p>可以看到，AndroidRuntime的start()函数主要做了以下三件事情。</p>
<ul>
<li><p>调用startVM()函数启动虚拟机</p>
<p>int AndroidRuntime::startVm(JavaVM<strong> pJavaVM, JNIEnv</strong> pEnv, bool zygote)｛</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">.......</div><div class="line"><span class="comment">// 主要通过JNI_CreateJavaVM()创建虚拟机</span></div><div class="line"><span class="keyword">if</span> (JNI_CreateJavaVM(pJavaVM, pEnv, &amp;initArgs) &lt; <span class="number">0</span>) &#123;</div><div class="line">    ALOGE(<span class="string">"JNI_CreateJavaVM failed\n"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>}</p>
</li>
<li><p>调用startReg()函数注册JNI方法</p>
<p> int AndroidRuntime::startReg(JNIEnv* env){</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ATRACE_NAME(<span class="string">"RegisterAndroidNatives"</span>);</div><div class="line">androidSetCreateThreadFunc((android_create_thread_fn) javaCreateThreadEtc);</div><div class="line">ALOGV(<span class="string">"--- registering native functions ---\n"</span>);</div><div class="line"></div><div class="line">env-&gt;PushLocalFrame(<span class="number">200</span>);</div><div class="line"><span class="comment">// startReg()函数通过register_jni_procs()函数去进一步注册，并且传递的值是gRegJNI变量，gRegJNI是一个数组。在android中，Java世界要调用native世界的函数就要用JNI机制，并且android系统中也大量使用JNI机制，register_jni_procs通过这个数组来完成Java到native方法的映射。</span></div><div class="line"><span class="keyword">if</span> (register_jni_procs(gRegJNI, NELEM(gRegJNI), env) &lt; <span class="number">0</span>) &#123;</div><div class="line">    env-&gt;PopLocalFrame(<span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line">env-&gt;PopLocalFrame(<span class="literal">NULL</span>);</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>}</p>
</li>
<li><p>调用ZygoteInit类的main函数</p>
<p>public static void main(String argv[]){</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">ZygoteHooks.startZygoteNoThreadCreation();</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"ZygoteInit"</span>);</div><div class="line">    RuntimeInit.enableDdms();</div><div class="line">  </div><div class="line">    SamplingProfilerIntegration.start();</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> startSystemServer = <span class="keyword">false</span>;</div><div class="line">    String socketName = <span class="string">"zygote"</span>;</div><div class="line">    String abiList = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="string">"start-system-server"</span>.equals(argv[i])) &#123;</div><div class="line">            startSystemServer = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</div><div class="line">            abiList = argv[i].substring(ABI_LIST_ARG.length());</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</div><div class="line">            socketName = argv[i].substring(SOCKET_NAME_ARG.length());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unknown command line argument: "</span> + argv[i]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (abiList == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No ABI list supplied."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    registerZygoteSocket(socketName);</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"ZygotePreload"</span>);</div><div class="line">    EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</div><div class="line">        SystemClock.uptimeMillis());</div><div class="line">  </div><div class="line">    preload();</div><div class="line">  </div><div class="line">    EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</div><div class="line">        SystemClock.uptimeMillis());</div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line"></div><div class="line">    SamplingProfilerIntegration.writeZygoteSnapshot();</div><div class="line"></div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"PostZygoteInitGC"</span>);</div><div class="line">    gcAndFinalize();</div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">    Trace.setTracingEnabled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">    Zygote.nativeUnmountStorageOnInit();</div><div class="line"></div><div class="line">    ZygoteHooks.stopZygoteNoThreadCreation();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (startSystemServer) &#123;</div><div class="line">        startSystemServer(abiList, socketName);</div><div class="line">    &#125;</div><div class="line">    Log.i(TAG, <span class="string">"Accepting command socket connections"</span>);</div><div class="line">  </div><div class="line">    runSelectLoop(abiList);</div><div class="line"></div><div class="line">    closeServerSocket();</div><div class="line">&#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</div><div class="line">    caller.run();</div><div class="line">&#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</div><div class="line">    Log.e(TAG, <span class="string">"Zygote died with exception"</span>, ex);</div><div class="line">    closeServerSocket();</div><div class="line">    <span class="keyword">throw</span> ex;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>}</p>
<p>ZygoteInit类的main()方法主要做了以下5项工作：</p>
<ul>
<li><p>调用registerZygoteSocket()函数创建一个zygote的socket接口，用来和AMS通信</p>
<p>​    private static void registerZygoteSocket(String socketName) {</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (sServerSocket == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="comment">// 使用文件描述符作为参数，通过new关键字创建了一个Java层的LocalServerSocket对象，目的是等待创建新的应用程序进程请求连接，而这个文件描述符代表的就是前面说的/dev/socket/zygote，即在init.rc中zygote service配置的内容</span></div><div class="line">    <span class="keyword">int</span> fileDesc;</div><div class="line">    <span class="keyword">final</span> String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        String env = System.getenv(fullSocketName);</div><div class="line">        fileDesc = Integer.parseInt(env);</div><div class="line">    &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(fullSocketName + <span class="string">" unset or invalid"</span>, ex);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        FileDescriptor fd = <span class="keyword">new</span> FileDescriptor();</div><div class="line">        fd.setInt$(fileDesc);</div><div class="line">        sServerSocket = <span class="keyword">new</span> LocalServerSocket(fd);</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Error binding to local socket '"</span> + fileDesc + <span class="string">"'"</span>, ex);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​    ｝</p>
</li>
<li><p>调用preload()预加载类和资源</p>
<p>static void preload() {</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">Log.d(TAG, <span class="string">"begin preload"</span>);</div><div class="line">Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"BeginIcuCachePinning"</span>);</div><div class="line">beginIcuCachePinning();</div><div class="line">Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"PreloadClasses"</span>);</div><div class="line"><span class="comment">// 加载类</span></div><div class="line">preloadClasses();</div><div class="line">Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"PreloadResources"</span>);</div><div class="line"><span class="comment">// 加载资源</span></div><div class="line">preloadResources();</div><div class="line">Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"PreloadOpenGL"</span>);</div><div class="line"><span class="comment">// 加载OpenGL</span></div><div class="line">preloadOpenGL();</div><div class="line">Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line"><span class="comment">// 加载共享库(预加载"android"，"compiler_rt", "jnigraphics"这几个库);</span></div><div class="line">preloadSharedLibraries();</div><div class="line">preloadTextResources();</div><div class="line"></div><div class="line">WebViewFactory.prepareWebViewInZygote();</div><div class="line">endIcuCachePinning();</div><div class="line">warmUpJcaProviders();</div><div class="line">Log.d(TAG, <span class="string">"end preload"</span>);</div></pre></td></tr></table></figure>
<p>}</p>
</li>
<li><p>调用startSystemServer()函数来启动SystemServer进程</p>
</li>
<li><p>调用runSelectLoop()函数在前面创建的socket接口上进入一个无限循环，等待核心服务AMS请求创建新的应用程序进程</p>
<p>private static void runSelectLoop(String abiList) throws MethodAndArgsCaller {</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">```c++</div><div class="line">ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</div><div class="line">ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();    </div><div class="line">fds.add(sServerSocket.getFileDescriptor());</div><div class="line">    peers.add(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</div><div class="line">            pollFds[i] = <span class="keyword">new</span> StructPollfd();</div><div class="line">            pollFds[i].fd = fds.get(i);</div><div class="line">            pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Os.poll(pollFds, -<span class="number">1</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"poll failed"</span>, ex);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</div><div class="line">            <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// 如果变量i==0，表示zygote socket服务还没有准备好，于是接下来就回去准备它，这个过程是zygote进程在启动时去做的</span></div><div class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</div><div class="line">                peers.add(newPeer);</div><div class="line">                fds.add(newPeer.getFileDesciptor());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 如果变量i!=0，表示正在等待客户端来连接“Zygote”这个socket，当有孵化子进程的请求时，就会调用ZygoteConnection的runOnce()函数创建新的子进程</span></div><div class="line">                <span class="keyword">boolean</span> done = peers.get(i).runOnce();</div><div class="line">                <span class="keyword">if</span> (done) &#123;</div><div class="line">                    peers.remove(i);</div><div class="line">                    fds.remove(i);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>  ｝</p>
<ul>
<li><p>调用caller.run()方法，当启动一个新进程，会抛出MethodAndArgsCaller异常，当捕获了这个异常之后，就调用MethodAndArgsCaller类的run方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  * 综上可以通过一张图来小结一下zygote启动的大概过程</div><div class="line"></div><div class="line">    ![zygote启动过程序列图](http://oxsxuoiqx.bkt.clouddn.com/zygote%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%BA%8F%E5%88%97%E5%9B%BE.png)</div><div class="line"></div><div class="line">#### 启动system_server进程</div><div class="line"></div><div class="line">* 首先，回顾一下android framework的启动过程</div><div class="line"></div><div class="line">  ![android framework启动过程](http://oxsxuoiqx.bkt.clouddn.com/android%20framework%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.png)</div><div class="line"></div><div class="line">  zygote启动虚拟机后，会再生成一个虚拟机实例，以便运行名称为SystemServer的Java服务，SystemServer用于运行Audio Flinger与Surface Flinger本地服务。在运行完所需的本地服务后，SystemServer开始运行android framework的服务，如AMS、WMS、PMS等。</div><div class="line"></div><div class="line">* 启动系统服务system_server进程从ZygoteInit.java的main()方法调用startSystemServer()方法开始。</div><div class="line"></div><div class="line">  ​    private static boolean startSystemServer(String abiList, String socketName)</div><div class="line"></div><div class="line">  ​             throws MethodAndArgsCaller, RuntimeException &#123;</div><div class="line"></div><div class="line">  ```java</div><div class="line">     long capabilities = posixCapabilitiesAsBits(</div><div class="line">          OsConstants.CAP_IPC_LOCK,</div><div class="line">          OsConstants.CAP_KILL,</div><div class="line">          OsConstants.CAP_NET_ADMIN,</div><div class="line">          OsConstants.CAP_NET_BIND_SERVICE,</div><div class="line">          OsConstants.CAP_NET_BROADCAST,</div><div class="line">          OsConstants.CAP_NET_RAW,</div><div class="line">          OsConstants.CAP_SYS_MODULE,</div><div class="line">          OsConstants.CAP_SYS_NICE,</div><div class="line">          OsConstants.CAP_SYS_RESOURCE,</div><div class="line">          OsConstants.CAP_SYS_TIME,</div><div class="line">          OsConstants.CAP_SYS_TTY_CONFIG</div><div class="line">      );</div><div class="line"></div><div class="line">      if (!SystemProperties.getBoolean(PROPERTY_RUNNING_IN_CONTAINER, false)) &#123;</div><div class="line">          capabilities |= posixCapabilitiesAsBits(OsConstants.CAP_BLOCK_SUSPEND);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      String args[] = &#123;</div><div class="line">          &quot;--setuid=1000&quot;,</div><div class="line">          &quot;--setgid=1000&quot;,</div><div class="line">          &quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007,3009,3010&quot;,</div><div class="line">          &quot;--capabilities=&quot; + capabilities + &quot;,&quot; + capabilities,</div><div class="line">          &quot;--nice-name=system_server&quot;,</div><div class="line">          &quot;--runtime-args&quot;,</div><div class="line">          &quot;com.android.server.SystemServer&quot;,</div><div class="line">      &#125;;</div><div class="line">      ZygoteConnection.Arguments parsedArgs = null;</div><div class="line"></div><div class="line">      int pid;</div><div class="line"></div><div class="line">      try &#123;</div><div class="line">          // 首先设置syytem_server进程的uid、gid和groups，然后设置进程的名字为--nice-name=system_server</div><div class="line">          parsedArgs = new ZygoteConnection.Arguments(args);</div><div class="line">          ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</div><div class="line">          ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</div><div class="line">        </div><div class="line">          // forkSystemServer()函数用来fork一个新的进程，它有两个返回值，一个在当前进程中返回，另一个在新创建的进程中返回，在当前进程中的返回值就是新创建的子进程的pid,而新创建进程中的返回值是0。所以，如果pid=0,表示已经进入SystemServer子进程。</div><div class="line">          pid = Zygote.forkSystemServer(</div><div class="line">                  parsedArgs.uid, parsedArgs.gid,</div><div class="line">                  parsedArgs.gids,</div><div class="line">                  parsedArgs.debugFlags,</div><div class="line">                  null,</div><div class="line">                  parsedArgs.permittedCapabilities,</div><div class="line">                  parsedArgs.effectiveCapabilities);</div><div class="line">      &#125; catch (IllegalArgumentException ex) &#123;</div><div class="line">          throw new RuntimeException(ex);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (pid == 0) &#123;</div><div class="line">          </div><div class="line">          if (hasSecondZygote(abiList)) &#123;</div><div class="line">              waitForSecondaryZygote(socketName);</div><div class="line">          &#125;</div><div class="line">          // 在system_server子进程中调用handleSystemServerProcess()方法用来关闭“Zygote”socket。</div><div class="line">          handleSystemServerProcess(parsedArgs);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      return true;</div></pre></td></tr></table></figure>
<p>}</p>
<p>接着看handleSystemServerProcess()方法实现</p>
<p>private static void handleSystemServerProcess(ZygoteConnection.Arguments parsedArgs)</p>
<p>​        throws ZygoteInit.MethodAndArgsCaller {</p>
</li>
</ul>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// handleSystemServerProcess首先会关闭socket，因为system_server进程继承了zygote进程，所以也继承了socket，但由于system_server不需要这个socket，所以必须close它。</span></div><div class="line">closeServerSocket();</div><div class="line">Os.umask(S_IRWXG | S_IRWXO);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</div><div class="line">    Process.setArgV0(parsedArgs.niceName);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">final</span> String systemServerClasspath = Os.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</div><div class="line"><span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</div><div class="line">    performSystemServerDexOpt(systemServerClasspath);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</div><div class="line">    String[] args = parsedArgs.remainingArgs;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</div><div class="line">        String[] amendedArgs = <span class="keyword">new</span> String[args.length + <span class="number">2</span>];</div><div class="line">        amendedArgs[<span class="number">0</span>] = <span class="string">"-cp"</span>;</div><div class="line">        amendedArgs[<span class="number">1</span>] = systemServerClasspath;</div><div class="line">        System.arraycopy(parsedArgs.remainingArgs, <span class="number">0</span>, amendedArgs, <span class="number">2</span>, parsedArgs.remainingArgs.length);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    WrapperInit.execApplication(parsedArgs.invokeWith,</div><div class="line">            parsedArgs.niceName, parsedArgs.targetSdkVersion,</div><div class="line">            VMRuntime.getCurrentInstructionSet(), <span class="keyword">null</span>, args);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    ClassLoader cl = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</div><div class="line">        cl = createSystemServerClassLoader(systemServerClasspath,</div><div class="line">                                           parsedArgs.targetSdkVersion);</div><div class="line"></div><div class="line">        Thread.currentThread().setContextClassLoader(cl);</div><div class="line">    &#125;</div><div class="line">   </div><div class="line">    RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  }</p>
<p>  handleSystemServerProcess()函数在最后调用了RuntimeInit.zygoteInit()方法，zygoteInit()主要调用了nativeZygoteInit()和applicationInit()这两个方法。</p>
<p>  public static final void zygoteInit(int targetSdkVersion, String[] argv, ClassLoader classLoader)</p>
<p>  ​                   throws ZygoteInit.MethodAndArgsCaller {</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting application from zygote"</span>);</div><div class="line">Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"RuntimeInit"</span>);</div><div class="line">redirectLogStreams();</div><div class="line"></div><div class="line">commonInit();</div><div class="line"><span class="comment">// 主要执行了Binder驱动程序初始化的相关工作，它调用之后system_server进程就可以进行Binder进程间通信</span></div><div class="line">nativeZygoteInit();</div><div class="line"><span class="comment">// 主要是进入SystemServer.java的main()方法</span></div><div class="line">applicationInit(targetSdkVersion, argv, classLoader);</div></pre></td></tr></table></figure>
<p>  ｝</p>
<p>  nativeZygoteInit()是一个native的方法，对应于jni下的AndroidRuntime.cpp文件里的com_android_internal_os_RuntimeInit_nativeZygoteInit()函数。</p>
<p>  static void com_android_internal_os_RuntimeInit_nativeZygoteInit(JNIEnv* env, jobject clazz) {</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// gCurRuntime是一个全局变量，指向AppRuntime,因此，这里实际调用的是AppRuntime的onZygoteInit()函数</span></div><div class="line">gCurRuntime-&gt;onZygoteInit();</div></pre></td></tr></table></figure>
<p>  }</p>
<p>  visual void onZygoteInit() {</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sp&lt;ProcessState&gt; proc = ProcessState::self();</div><div class="line">ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</div><div class="line"><span class="comment">// 变量proc是一个ProcessState对象，这里调用它的函数startThreadPool来启动线程池，用来进行进程间通信</span></div><div class="line">proc-&gt;startThreadPool();</div></pre></td></tr></table></figure>
<p>  }</p>
<p>  回到前面再继续看看applicationInit()方法怎样一步步进入SystemServer的main()方法。</p>
<p>  private static void applicationInit(int targetSdkVersion, String[] argv, ClassLoader classLoader)</p>
<p>  ​        throws ZygoteInit.MethodAndArgsCaller {</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">nativeSetExitWithoutCleanup(<span class="keyword">true</span>);</div><div class="line">VMRuntime.getRuntime().setTargetHeapUtilization(<span class="number">0.75f</span>);</div><div class="line">VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);</div><div class="line"></div><div class="line"><span class="keyword">final</span> Arguments args;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    args = <span class="keyword">new</span> Arguments(argv);</div><div class="line">&#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">    Slog.e(TAG, ex.getMessage());</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line"><span class="comment">// 该方法调用之后就会进入类的main()方法</span></div><div class="line">invokeStaticMain(args.startClass, args.startArgs, classLoader);</div></pre></td></tr></table></figure>
<p>  ｝</p>
<p>  private static void invokeStaticMain(String className, String[] argv, ClassLoader classLoader)</p>
<p>  ​        throws ZygoteInit.MethodAndArgsCaller {</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; cl;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// 通过Class.forName把类加载进来，在目前情况下，这个类就是前面传过来的SystemServer类</span></div><div class="line">    cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</div><div class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">            <span class="string">"Missing class when invoking static main "</span> + className,</div><div class="line">            ex);</div><div class="line">&#125;</div><div class="line"></div><div class="line">Method m;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// 通过cl.getMethod获取加载类的静态main()方法，即获取SystemServer类的main()方法</span></div><div class="line">    m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</div><div class="line">&#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">            <span class="string">"Missing static main on "</span> + className, ex);</div><div class="line">&#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">            <span class="string">"Problem getting static main on "</span> + className, ex);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> modifiers = m.getModifiers();</div><div class="line"><span class="keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">            <span class="string">"Main method is not public and static on "</span> + className);</div><div class="line">&#125;</div><div class="line"><span class="comment">// 最后并没有直接调用SystemServer类的main()方法，而是通过关键字throw抛出一个异常对象ZygoteInit.MethodAndArgsCaller，从前面的分析可以知道，这个异常对象在ZygoteInit的main()函数中被捕获，当捕获这个异常之后就会调用SystemServer类的main()方法，之所以通过抛出异常来进入加载类的main()方法，目的是清理堆栈，这样做会让加载SystemServer类的main()方法觉得自己是进程的入口类</span></div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ZygoteInit.MethodAndArgsCaller(m, argv);</div></pre></td></tr></table></figure>
<p>  ｝</p>
<h4 id="启动app应用程序进程"><a href="#启动app应用程序进程" class="headerlink" title="启动app应用程序进程"></a>启动app应用程序进程</h4><p>前面分析了zygote如何启动SystemServer子进程，接下类再分析zygote如何启动其他子进程，也就是创建应用程序进程的过程，这个过程和创建SystemServer进程基本一样。</p>
<ul>
<li><p>当点击Launcher主界面的一个应用程序图标时，如果这个应用程序还未曾启动，就会启动它。而判断应用程序有没有启动都由核心服务ActivityManagerService来做，它的startProcessLocked()方法会真正地启动应用程序子进程。</p>
<p>private final void startProcessLocked(ProcessRecord app, String hostingType, String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs) {</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> startTime = SystemClock.elapsedRealtime();</div><div class="line"><span class="keyword">if</span> (app.pid &gt; <span class="number">0</span> &amp;&amp; app.pid != MY_PID) &#123;</div><div class="line">    checkTime(startTime, <span class="string">"startProcess: removing from pids map"</span>);</div><div class="line">    <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</div><div class="line">        mPidsSelfLocked.remove(app.pid);</div><div class="line">        mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</div><div class="line">    &#125;</div><div class="line">    checkTime(startTime, <span class="string">"startProcess: done removing from pids map"</span>);</div><div class="line">    app.setPid(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (DEBUG_PROCESSES &amp;&amp; mProcessesOnHold.contains(app)) Slog.v(TAG_PROCESSES,</div><div class="line">        <span class="string">"startProcessLocked removing on hold: "</span> + app);</div><div class="line">mProcessesOnHold.remove(app);</div><div class="line"></div><div class="line">checkTime(startTime, <span class="string">"startProcess: starting to update cpu stats"</span>);</div><div class="line">updateCpuStats();</div><div class="line">checkTime(startTime, <span class="string">"startProcess: done updating cpu stats"</span>);</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(app.uid);</div><div class="line">        AppGlobals.getPackageManager().checkPackageStartable(app.info.packageName, userId);</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="keyword">throw</span> e.rethrowAsRuntimeException();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> uid = app.uid;</div><div class="line">    <span class="keyword">int</span>[] gids = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">int</span> mountExternal = Zygote.MOUNT_EXTERNAL_NONE;</div><div class="line">    <span class="keyword">if</span> (!app.isolated) &#123;</div><div class="line">        <span class="keyword">int</span>[] permGids = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            checkTime(startTime, <span class="string">"startProcess: getting gids from package manager"</span>);</div><div class="line">            <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</div><div class="line">            permGids = pm.getPackageGids(app.info.packageName,</div><div class="line">                    MATCH_DEBUG_TRIAGED_MISSING, app.userId);</div><div class="line">            MountServiceInternal mountServiceInternal = LocalServices.getService(</div><div class="line">                    MountServiceInternal.class);</div><div class="line">            mountExternal = mountServiceInternal.getExternalStorageMountMode(uid,</div><div class="line">                    app.info.packageName);</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            <span class="keyword">throw</span> e.rethrowAsRuntimeException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ArrayUtils.isEmpty(permGids)) &#123;</div><div class="line">            gids = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            gids = <span class="keyword">new</span> <span class="keyword">int</span>[permGids.length + <span class="number">2</span>];</div><div class="line">            System.arraycopy(permGids, <span class="number">0</span>, gids, <span class="number">2</span>, permGids.length);</div><div class="line">        &#125;</div><div class="line">        gids[<span class="number">0</span>] = UserHandle.getSharedAppGid(UserHandle.getAppId(uid));</div><div class="line">        gids[<span class="number">1</span>] = UserHandle.getUserGid(UserHandle.getUserId(uid));</div><div class="line">    &#125;</div><div class="line">    checkTime(startTime, <span class="string">"startProcess: building args"</span>);</div><div class="line">    <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_OFF) &#123;</div><div class="line">        <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</div><div class="line">                &amp;&amp; mTopComponent != <span class="keyword">null</span></div><div class="line">                &amp;&amp; app.processName.equals(mTopComponent.getPackageName())) &#123;</div><div class="line">            uid = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_HIGH_LEVEL</div><div class="line">                &amp;&amp; (app.info.flags&amp;ApplicationInfo.FLAG_FACTORY_TEST) != <span class="number">0</span>) &#123;</div><div class="line">            uid = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> debugFlags = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> ((app.info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>) &#123;</div><div class="line">        debugFlags |= Zygote.DEBUG_ENABLE_DEBUGGER;</div><div class="line">        debugFlags |= Zygote.DEBUG_ENABLE_CHECKJNI;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((app.info.flags &amp; ApplicationInfo.FLAG_VM_SAFE_MODE) != <span class="number">0</span> ||</div><div class="line">        mSafeMode == <span class="keyword">true</span>) &#123;</div><div class="line">        debugFlags |= Zygote.DEBUG_ENABLE_SAFEMODE;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="string">"1"</span>.equals(SystemProperties.get(<span class="string">"debug.checkjni"</span>))) &#123;</div><div class="line">        debugFlags |= Zygote.DEBUG_ENABLE_CHECKJNI;</div><div class="line">    &#125;</div><div class="line">    String genDebugInfoProperty = SystemProperties.get(<span class="string">"debug.generate-debug-info"</span>);</div><div class="line">    <span class="keyword">if</span> (<span class="string">"true"</span>.equals(genDebugInfoProperty)) &#123;</div><div class="line">        debugFlags |= Zygote.DEBUG_GENERATE_DEBUG_INFO;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="string">"1"</span>.equals(SystemProperties.get(<span class="string">"debug.jni.logging"</span>))) &#123;</div><div class="line">        debugFlags |= Zygote.DEBUG_ENABLE_JNI_LOGGING;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="string">"1"</span>.equals(SystemProperties.get(<span class="string">"debug.assert"</span>))) &#123;</div><div class="line">        debugFlags |= Zygote.DEBUG_ENABLE_ASSERT;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mNativeDebuggingApp != <span class="keyword">null</span> &amp;&amp; mNativeDebuggingApp.equals(app.processName)) &#123;</div><div class="line">        debugFlags |= Zygote.DEBUG_ALWAYS_JIT;          <span class="comment">// Don't interpret anything</span></div><div class="line">        debugFlags |= Zygote.DEBUG_GENERATE_DEBUG_INFO; <span class="comment">// Generate debug info</span></div><div class="line">        debugFlags |= Zygote.DEBUG_NATIVE_DEBUGGABLE;   <span class="comment">// Disbale optimizations</span></div><div class="line">        mNativeDebuggingApp = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String requiredAbi = (abiOverride != <span class="keyword">null</span>) ? abiOverride : app.info.primaryCpuAbi;</div><div class="line">    <span class="keyword">if</span> (requiredAbi == <span class="keyword">null</span>) &#123;</div><div class="line">        requiredAbi = Build.SUPPORTED_ABIS[<span class="number">0</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String instructionSet = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (app.info.primaryCpuAbi != <span class="keyword">null</span>) &#123;</div><div class="line">        instructionSet = VMRuntime.getInstructionSet(app.info.primaryCpuAbi);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    app.gids = gids;</div><div class="line">    app.requiredAbi = requiredAbi;</div><div class="line">    app.instructionSet = instructionSet;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> isActivityProcess = (entryPoint == <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">if</span> (entryPoint == <span class="keyword">null</span>) entryPoint = <span class="string">"android.app.ActivityThread"</span>;</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"Start proc: "</span> +</div><div class="line">            app.processName);</div><div class="line">    checkTime(startTime, <span class="string">"startProcess: asking zygote to start proc"</span>);</div><div class="line">    <span class="comment">// AMS的startProcessLocked()方法调用了Process类的start()方法为应用程序创建新的进程，这里的参数entryPoint为"android.app.ActivityThread"，它是传进去的第一个参数，也就是应用程序初始化进程时要加载的主文件Java类。当应用程序启动之后，会把这个类加载到进程，调用它的main()方法作为应用程序进程的入口。</span></div><div class="line">    Process.ProcessStartResult startResult = Process.start(entryPoint,</div><div class="line">            app.processName, uid, uid, gids, debugFlags, mountExternal,</div><div class="line">            app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</div><div class="line">            app.info.dataDir, entryPointArgs);</div><div class="line">    checkTime(startTime, <span class="string">"startProcess: returned from zygote!"</span>);</div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app.isolated) &#123;</div><div class="line">        mBatteryStatsService.addIsolatedUid(app.uid, app.info.uid);</div><div class="line">    &#125;</div><div class="line">    mBatteryStatsService.noteProcessStart(app.processName, app.info.uid);</div><div class="line">    checkTime(startTime, <span class="string">"startProcess: done updating battery stats"</span>);</div><div class="line"></div><div class="line">    EventLog.writeEvent(EventLogTags.AM_PROC_START,</div><div class="line">            UserHandle.getUserId(uid), startResult.pid, uid,</div><div class="line">            app.processName, hostingType,</div><div class="line">            hostingNameStr != <span class="keyword">null</span> ? hostingNameStr : <span class="string">""</span>);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        AppGlobals.getPackageManager().logAppProcessStartIfNeeded(app.processName, app.uid,</div><div class="line">                app.info.seinfo, app.info.sourceDir, startResult.pid);</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app.persistent) &#123;</div><div class="line">        Watchdog.getInstance().processStarted(app.processName, startResult.pid);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    checkTime(startTime, <span class="string">"startProcess: building log message"</span>);</div><div class="line">    StringBuilder buf = mStringBuilder;</div><div class="line">    buf.setLength(<span class="number">0</span>);</div><div class="line">    buf.append(<span class="string">"Start proc "</span>);</div><div class="line">    buf.append(startResult.pid);</div><div class="line">    buf.append(<span class="string">':'</span>);</div><div class="line">    buf.append(app.processName);</div><div class="line">    buf.append(<span class="string">'/'</span>);</div><div class="line">    UserHandle.formatUid(buf, uid);</div><div class="line">    <span class="keyword">if</span> (!isActivityProcess) &#123;</div><div class="line">        buf.append(<span class="string">" ["</span>);</div><div class="line">        buf.append(entryPoint);</div><div class="line">        buf.append(<span class="string">"]"</span>);</div><div class="line">    &#125;</div><div class="line">    buf.append(<span class="string">" for "</span>);</div><div class="line">    buf.append(hostingType);</div><div class="line">    <span class="keyword">if</span> (hostingNameStr != <span class="keyword">null</span>) &#123;</div><div class="line">        buf.append(<span class="string">" "</span>);</div><div class="line">        buf.append(hostingNameStr);</div><div class="line">    &#125;</div><div class="line">    Slog.i(TAG, buf.toString());</div><div class="line">    app.setPid(startResult.pid);</div><div class="line">    app.usingWrapper = startResult.usingWrapper;</div><div class="line">    app.removed = <span class="keyword">false</span>;</div><div class="line">    app.killed = <span class="keyword">false</span>;</div><div class="line">    app.killedByAm = <span class="keyword">false</span>;</div><div class="line">    checkTime(startTime, <span class="string">"startProcess: starting to update pids map"</span>);</div><div class="line">    <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</div><div class="line">        <span class="keyword">this</span>.mPidsSelfLocked.put(startResult.pid, app);</div><div class="line">        <span class="keyword">if</span> (isActivityProcess) &#123;</div><div class="line">            Message msg = mHandler.obtainMessage(PROC_START_TIMEOUT_MSG);</div><div class="line">            msg.obj = app;</div><div class="line">            mHandler.sendMessageDelayed(msg, startResult.usingWrapper</div><div class="line">                    ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    checkTime(startTime, <span class="string">"startProcess: done updating pids map"</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">    Slog.e(TAG, <span class="string">"Failure starting process "</span> + app.processName, e);</div><div class="line"></div><div class="line">    forceStopPackageLocked(app.info.packageName, UserHandle.getAppId(app.uid), <span class="keyword">false</span>,</div><div class="line">            <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, UserHandle.getUserId(app.userId), <span class="string">"start failure"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>}</p>
<p>接下来看看Process的start()方法。</p>
<p>public static final ProcessStartResult start(final String processClass,</p>
<p>final String niceName,</p>
<p>int uid, int gid, int[] gids,</p>
<p>int debugFlags, int mountExternal,</p>
<p>int targetSdkVersion,</p>
<p>String seInfo,</p>
<p>String abi,<br>String instructionSet,<br>String appDataDir,<br>String[] zygoteArgs) { </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</div><div class="line">            debugFlags, mountExternal, targetSdkVersion, seInfo,</div><div class="line">            abi, instructionSet, appDataDir, zygoteArgs);</div><div class="line">&#125; <span class="keyword">catch</span> (ZygoteStartFailedEx ex) &#123;</div><div class="line">    Log.e(LOG_TAG,</div><div class="line">            <span class="string">"Starting VM process through Zygote failed"</span>);</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">            <span class="string">"Starting VM process through Zygote failed"</span>, ex);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>}</p>
<p>Process类的start()方法就是简单地调用startViaZygote()方法来进一步操作。</p>
<p>public static ProcessStartResult startViaZygote(final String processClass,</p>
<p>final String niceName,</p>
<p>final int uid, final int gid,</p>
<p>final int[] gids,</p>
<p>int debugFlags, int mountExternal,</p>
<p>int targetSdkVersion,</p>
<p>String seInfo,</p>
<p>String abi,<br>String instructionSet,<br>String appDataDir,<br>String[] extraArgs)</p>
<p>throws ZygoteStartFailedEx { </p>
</li>
</ul>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">synchronized</span>(Process.class) &#123;</div><div class="line">    ArrayList&lt;String&gt; argsForZygote = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// 设置参数值，这些值是应用程序在安装时系统分配好的</span></div><div class="line">    argsForZygote.add(<span class="string">"--runtime-args"</span>);</div><div class="line">    argsForZygote.add(<span class="string">"--setuid="</span> + uid);</div><div class="line">    argsForZygote.add(<span class="string">"--setgid="</span> + gid);</div><div class="line">    <span class="keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_JNI_LOGGING) != <span class="number">0</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--enable-jni-logging"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_SAFEMODE) != <span class="number">0</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--enable-safemode"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_DEBUGGER) != <span class="number">0</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--enable-debugger"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_CHECKJNI) != <span class="number">0</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--enable-checkjni"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_GENERATE_DEBUG_INFO) != <span class="number">0</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--generate-debug-info"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ALWAYS_JIT) != <span class="number">0</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--always-jit"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_NATIVE_DEBUGGABLE) != <span class="number">0</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--native-debuggable"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_ASSERT) != <span class="number">0</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--enable-assert"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_DEFAULT) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--mount-external-default"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_READ) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--mount-external-read"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_WRITE) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--mount-external-write"</span>);</div><div class="line">    &#125;</div><div class="line">    argsForZygote.add(<span class="string">"--target-sdk-version="</span> + targetSdkVersion);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (gids != <span class="keyword">null</span> &amp;&amp; gids.length &gt; <span class="number">0</span>) &#123;</div><div class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">        sb.append(<span class="string">"--setgroups="</span>);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> sz = gids.length;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</div><div class="line">                sb.append(<span class="string">','</span>);</div><div class="line">            &#125;</div><div class="line">            sb.append(gids[i]);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        argsForZygote.add(sb.toString());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (niceName != <span class="keyword">null</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--nice-name="</span> + niceName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (seInfo != <span class="keyword">null</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--seinfo="</span> + seInfo);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (instructionSet != <span class="keyword">null</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--instruction-set="</span> + instructionSet);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (appDataDir != <span class="keyword">null</span>) &#123;</div><div class="line">        argsForZygote.add(<span class="string">"--app-data-dir="</span> + appDataDir);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    argsForZygote.add(processClass);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (extraArgs != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (String arg : extraArgs) &#123;</div><div class="line">            argsForZygote.add(arg);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 调用openZygoteSocketIfNeeded()方法链接“zygote”socket，主要是通过ZygoteState的connect()方法去链接“zygote”socket。zygoteSendArgsAndGetResult()方法通过socket写入流writer把前面传过来的那些参数写进去，socket即ZygoteInit类的runSelectLoop()函数监听。写入这些数据后，ZygoteInit类的runSelectLoop()函数就能被监听到。</span></div><div class="line">    <span class="keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  ｝</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> <span class="keyword">throws</span> MethodAndArgsCaller </span>&#123;</div><div class="line">    ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</div><div class="line">    ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</div><div class="line"></div><div class="line">    fds.add(sServerSocket.getFileDescriptor());</div><div class="line">    peers.add(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</div><div class="line">            pollFds[i] = <span class="keyword">new</span> StructPollfd();</div><div class="line">            pollFds[i].fd = fds.get(i);</div><div class="line">            pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Os.poll(pollFds, -<span class="number">1</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"poll failed"</span>, ex);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</div><div class="line">            <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</div><div class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</div><div class="line">                peers.add(newPeer);</div><div class="line">                fds.add(newPeer.getFileDesciptor());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 当监听到runSelectLoop()函数之后，就会调用peers.get(i).runOnce()方法做进一步处理</span></div><div class="line">                <span class="keyword">boolean</span> done = peers.get(i).runOnce();</div><div class="line">                <span class="keyword">if</span> (done) &#123;</div><div class="line">                    peers.remove(i);</div><div class="line">                    fds.remove(i);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">runOnce</span><span class="params">()</span> <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;    </div><div class="line">    String args[];</div><div class="line">    Arguments parsedArgs = <span class="keyword">null</span>;</div><div class="line">    FileDescriptor[] descriptors;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        args = readArgumentList();</div><div class="line">        descriptors = mSocket.getAncillaryFileDescriptors();</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">        Log.w(TAG, <span class="string">"IOException on command socket "</span> + ex.getMessage());</div><div class="line">        closeSocket();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</div><div class="line">        closeSocket();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    PrintStream newStderr = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (descriptors != <span class="keyword">null</span> &amp;&amp; descriptors.length &gt;= <span class="number">3</span>) &#123;</div><div class="line">        newStderr = <span class="keyword">new</span> PrintStream(</div><div class="line">                <span class="keyword">new</span> FileOutputStream(descriptors[<span class="number">2</span>]));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> pid = -<span class="number">1</span>;</div><div class="line">    FileDescriptor childPipeFd = <span class="keyword">null</span>;</div><div class="line">    FileDescriptor serverPipeFd = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        parsedArgs = <span class="keyword">new</span> Arguments(args);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (parsedArgs.abiListQuery) &#123;</div><div class="line">            <span class="keyword">return</span> handleAbiListQuery();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (parsedArgs.permittedCapabilities != <span class="number">0</span> || parsedArgs.effectiveCapabilities != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteSecurityException(<span class="string">"Client may not specify capabilities: "</span> +</div><div class="line">                    <span class="string">"permitted=0x"</span> + Long.toHexString(parsedArgs.permittedCapabilities) +</div><div class="line">                    <span class="string">", effective=0x"</span> + Long.toHexString(parsedArgs.effectiveCapabilities));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        applyUidSecurityPolicy(parsedArgs, peer);</div><div class="line">        applyInvokeWithSecurityPolicy(parsedArgs, peer);</div><div class="line"></div><div class="line">        applyDebuggerSystemProperty(parsedArgs);</div><div class="line">        applyInvokeWithSystemProperty(parsedArgs);</div><div class="line"></div><div class="line">        <span class="keyword">int</span>[][] rlimits = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (parsedArgs.rlimits != <span class="keyword">null</span>) &#123;</div><div class="line">            rlimits = parsedArgs.rlimits.toArray(intArray2d);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</div><div class="line">            FileDescriptor[] pipeFds = Os.pipe2(O_CLOEXEC);</div><div class="line">            childPipeFd = pipeFds[<span class="number">1</span>];</div><div class="line">            serverPipeFd = pipeFds[<span class="number">0</span>];</div><div class="line">            Os.fcntlInt(childPipeFd, F_SETFD, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> [] fdsToClose = &#123; -<span class="number">1</span>, -<span class="number">1</span> &#125;;</div><div class="line"></div><div class="line">        FileDescriptor fd = mSocket.getFileDescriptor();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (fd != <span class="keyword">null</span>) &#123;</div><div class="line">            fdsToClose[<span class="number">0</span>] = fd.getInt$();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        fd = ZygoteInit.getServerSocketFileDescriptor();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (fd != <span class="keyword">null</span>) &#123;</div><div class="line">            fdsToClose[<span class="number">1</span>] = fd.getInt$();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        fd = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="comment">// 之前启动SystemServer进程的代码与此有点相似。此处是通过Zygote.forkAndSpecialize()来fork新的应用程序进程，而启动system_server进程时是通过Zygote.forkSystemServer()来fork SystemServer进程。</span></div><div class="line">        pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</div><div class="line">                parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</div><div class="line">                parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,</div><div class="line">                parsedArgs.appDataDir);</div><div class="line">    &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">        logAndPrintError(newStderr, <span class="string">"Exception creating pipe"</span>, ex);</div><div class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">        logAndPrintError(newStderr, <span class="string">"Invalid zygote arguments"</span>, ex);</div><div class="line">    &#125; <span class="keyword">catch</span> (ZygoteSecurityException ex) &#123;</div><div class="line">        logAndPrintError(newStderr,</div><div class="line">                <span class="string">"Zygote security policy prevents request: "</span>, ex);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 在子进程中，这里通过handleChildProc()方法能做进一步处理，而之前是通过调用handleSystemServerProc()来处理</span></div><div class="line">            IoUtils.closeQuietly(serverPipeFd);</div><div class="line">            serverPipeFd = <span class="keyword">null</span>;</div><div class="line">            handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            IoUtils.closeQuietly(childPipeFd);</div><div class="line">            childPipeFd = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        IoUtils.closeQuietly(childPipeFd);</div><div class="line">        IoUtils.closeQuietly(serverPipeFd);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleChildProc</span><span class="params">(Arguments parsedArgs,</span></span></div><div class="line">        FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr)</div><div class="line">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line"></div><div class="line">    closeSocket();</div><div class="line">    ZygoteInit.closeServerSocket();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (descriptors != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Os.dup2(descriptors[<span class="number">0</span>], STDIN_FILENO);</div><div class="line">            Os.dup2(descriptors[<span class="number">1</span>], STDOUT_FILENO);</div><div class="line">            Os.dup2(descriptors[<span class="number">2</span>], STDERR_FILENO);</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (FileDescriptor fd: descriptors) &#123;</div><div class="line">                IoUtils.closeQuietly(fd);</div><div class="line">            &#125;</div><div class="line">            newStderr = System.err;</div><div class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"Error reopening stdio"</span>, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</div><div class="line">        Process.setArgV0(parsedArgs.niceName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">    <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</div><div class="line">        WrapperInit.execApplication(parsedArgs.invokeWith,</div><div class="line">                parsedArgs.niceName, parsedArgs.targetSdkVersion,</div><div class="line">                VMRuntime.getCurrentInstructionSet(),</div><div class="line">                pipeFd, parsedArgs.remainingArgs);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// handleChildProc()方法调用了RuntimeInit类的zygoteInit()方法来做进一步处理，后面的启动过程跟前面启动SystemServer的过程基本一样，唯一不同的是SystemServer进程启动之后进入的主类是SystemServer.java,而应用程序进程启动起来之后进入的主类是ActivityThread.java,但最终都会进入main()方法。</span></div><div class="line">        RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion,</div><div class="line">                parsedArgs.remainingArgs, <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>至此，zygote进程以及zygote进程启动SystemServer进程和启动应用程序进程就分析完了。zygote进程为了启动SystemServer进程和启动应用程序进程主要做了两件事：</p>
<ul>
<li>初始化Binder驱动用来进行进程间通信</li>
<li>通过反射进入main()方法</li>
</ul>
<p>zygote进程是android应用运行必须的进程，zygote进程如何运行、如何初始化，以及如何通过它来提高应用的运行速度等，是需要讨论的主要内容。在android平台下，zygote进程有助于快速运行应用程序，可以高效地向android平台添加资源，快速加载相关类，在运行新的应用程序的过程中减小系统开销。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android-framework/" rel="tag"># android framework</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/15/android启动过程分析（二）/" rel="next" title="android启动过程分析——Context Manager">
                <i class="fa fa-chevron-left"></i> android启动过程分析——Context Manager
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/10/17/浅析SystemServer进程/" rel="prev" title="浅析SystemServer进程">
                浅析SystemServer进程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/icon.jpg"
                alt="sufushi" />
            
              <p class="site-author-name" itemprop="name">sufushi</p>
              <p class="site-description motion-element" itemprop="description">这是苏富仕的博客</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/sufushi" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#概要"><span class="nav-number">1.</span> <span class="nav-text">概要</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#zygote进程的启动"><span class="nav-number">2.</span> <span class="nav-text">zygote进程的启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动app应用程序进程"><span class="nav-number">3.</span> <span class="nav-text">启动app应用程序进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结"><span class="nav-number">4.</span> <span class="nav-text">小结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sufushi</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.3"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.3"></script>


  

</body>
</html>
