<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="android框架源码解析," />










<meta name="description" content="前言合理利用本地缓存可以有效地减少网络开销，减少响应延迟。
HTTP缓存策略
HTTP报头也定义了很多与缓存有关的域来控制缓存。

Expires
超时时间，一般用在服务器的response报头中用于告知客户端对应资源的过期时间。当客户端需要再次请求相同资源时先比较其过期时间，如果尚未超过过期时间则直接返回缓存结果，如果已经超过则重新请求

Cache-Control
相对值，单位为秒，表示当前资">
<meta property="og:type" content="article">
<meta property="og:title" content="OkHttp框架源码解析——缓存策略">
<meta property="og:url" content="sufushi.github.io/2018/01/26/OkHttp框架源码解析（四）/index.html">
<meta property="og:site_name" content="苏富仕的博客">
<meta property="og:description" content="前言合理利用本地缓存可以有效地减少网络开销，减少响应延迟。
HTTP缓存策略
HTTP报头也定义了很多与缓存有关的域来控制缓存。

Expires
超时时间，一般用在服务器的response报头中用于告知客户端对应资源的过期时间。当客户端需要再次请求相同资源时先比较其过期时间，如果尚未超过过期时间则直接返回缓存结果，如果已经超过则重新请求

Cache-Control
相对值，单位为秒，表示当前资">
<meta property="og:updated_time" content="2018-03-03T02:18:48.947Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OkHttp框架源码解析——缓存策略">
<meta name="twitter:description" content="前言合理利用本地缓存可以有效地减少网络开销，减少响应延迟。
HTTP缓存策略
HTTP报头也定义了很多与缓存有关的域来控制缓存。

Expires
超时时间，一般用在服务器的response报头中用于告知客户端对应资源的过期时间。当客户端需要再次请求相同资源时先比较其过期时间，如果尚未超过过期时间则直接返回缓存结果，如果已经超过则重新请求

Cache-Control
相对值，单位为秒，表示当前资">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="sufushi.github.io/2018/01/26/OkHttp框架源码解析（四）/"/>





  <title>OkHttp框架源码解析——缓存策略 | 苏富仕的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">苏富仕的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">-4</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="sufushi.github.io/2018/01/26/OkHttp框架源码解析（四）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sufushi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏富仕的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">OkHttp框架源码解析——缓存策略</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-26T10:08:06+08:00">
                2018-01-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>合理利用本地缓存可以有效地减少网络开销，减少响应延迟。</p>
<p><strong>HTTP缓存策略</strong></p>
<p>HTTP报头也定义了很多与缓存有关的域来控制缓存。</p>
<ul>
<li><p>Expires</p>
<p>超时时间，一般用在服务器的response报头中用于告知客户端对应资源的过期时间。当客户端需要再次请求相同资源时先比较其过期时间，如果尚未超过过期时间则直接返回缓存结果，如果已经超过则重新请求</p>
</li>
<li><p>Cache-Control</p>
<p>相对值，单位为秒，表示当前资源的有效期，Cache-Control比Expires优先级更高</p>
</li>
<li><p>条件GET请求</p>
<ul>
<li><p>Last-Modified-Date</p>
<p>客户端第一次请求时，服务器返回：Last-Modified: Tue, 12 Jan 2016 09:31:27 GMT</p>
<p>当客户端二次请求时，可以在头部加上header：If-Modified-Since: Tue, 12 Jan 2016 09:31:27 GMT</p>
<p>如果当前资源没有被二次修改，服务器返回304告知客户端直接复用本地缓存</p>
</li>
<li><p>ETag</p>
<p>ETag是对资源文件的一种摘要，可以通过ETag值来判断文件是否有修改。</p>
<p>当客户端第一次请求某资源时，服务器返回：ETag: “5694c7ef-24dc”</p>
<p>客户端再次请求时，可在头部加上如下域：If-None-Match: “5694c7ef-24dc”</p>
<p>如果文件并未改变，则服务器返回304告知客户端可以复用本地缓存</p>
</li>
</ul>
</li>
<li><p>no-cache / no-store</p>
<p>不使用缓存</p>
</li>
<li><p>only-if-chched</p>
<p>只使用缓存</p>
</li>
</ul>
<h4 id="Cache源码分析"><a href="#Cache源码分析" class="headerlink" title="Cache源码分析"></a>Cache源码分析</h4><p>OkHttp的缓存工作都是在CacheInterceptor中完成的，Cache部分有如下几个关键类：</p>
<ul>
<li><p>Cache：Cache管理器，其内部包含一个DiskLruCache将cache写入文件系统</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Cache</span> <span class="keyword">implements</span> <span class="title">Closeable</span>, <span class="title">Flushable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">final</span> DiskLruCache cache;</div><div class="line">  	...</div><div class="line">    <span class="comment">// Cache内部通过以下三个统计指标来优化缓存效率</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> networkCount;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> hitCount;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> requestCount;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>CacheStrategy：缓存策略，其内部维护一个request和response，通过指定request和response来描述是通过网络还是缓存获取response，抑或二者同时使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheStrategy</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> Request networkRequest;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> Response cacheResponse;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>CacheStrategy.Factory：缓存策略工厂类，根据实际请求返回对应的缓存策略</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">long</span> nowMillis;</div><div class="line">   <span class="keyword">final</span> Request request;</div><div class="line">   <span class="keyword">final</span> Response cacheResponse;</div><div class="line">...</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>既然实际的缓存工作都是在CacheInterceptor中完成的，那么接下来看下cacheInterceptor的核心方法intercept方法源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  	<span class="comment">// 首先尝试获取缓存</span></div><div class="line">    Response cacheCandidate = cache != <span class="keyword">null</span></div><div class="line">        ? cache.get(chain.request())</div><div class="line">        : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">	<span class="comment">// 获取缓存策略</span></div><div class="line">    CacheStrategy strategy = <span class="keyword">new</span> CacheStrategy.Factory(now, chain.request(), 			          										cacheCandidate).get();</div><div class="line">    Request networkRequest = strategy.networkRequest;</div><div class="line">    Response cacheResponse = strategy.cacheResponse;</div><div class="line">	<span class="comment">// 如果有缓存，更新下相关统计指标：命中率</span></div><div class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</div><div class="line">      cache.trackResponse(strategy);</div><div class="line">    &#125;</div><div class="line">	<span class="comment">// 如果当前缓存不符合要求，将其close</span></div><div class="line">    <span class="keyword">if</span> (cacheCandidate != <span class="keyword">null</span> &amp;&amp; cacheResponse == <span class="keyword">null</span>) &#123;</div><div class="line">      closeQuietly(cacheCandidate.body()); </div><div class="line">    &#125;</div><div class="line">	<span class="comment">// 如果不能使用网络，同时又没有符合条件的缓存，直接抛504错误</span></div><div class="line">    <span class="keyword">if</span> (networkRequest == <span class="keyword">null</span> &amp;&amp; cacheResponse == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Response.Builder()</div><div class="line">          .request(chain.request())</div><div class="line">          .protocol(Protocol.HTTP_1_1)</div><div class="line">          .code(<span class="number">504</span>)</div><div class="line">          .message(<span class="string">"Unsatisfiable Request (only-if-cached)"</span>)</div><div class="line">          .body(Util.EMPTY_RESPONSE)</div><div class="line">          .sentRequestAtMillis(-<span class="number">1L</span>)</div><div class="line">          .receivedResponseAtMillis(System.currentTimeMillis())</div><div class="line">          .build();</div><div class="line">    &#125;</div><div class="line">	<span class="comment">// 如果有缓存同时又不使用网络，则直接返回缓存结果</span></div><div class="line">    <span class="keyword">if</span> (networkRequest == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> cacheResponse.newBuilder()</div><div class="line">          .cacheResponse(stripBody(cacheResponse))</div><div class="line">          .build();</div><div class="line">    &#125;</div><div class="line">	<span class="comment">// 尝试通过网络获取回复</span></div><div class="line">    Response networkResponse = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      networkResponse = chain.proceed(networkRequest);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="keyword">if</span> (networkResponse == <span class="keyword">null</span> &amp;&amp; cacheCandidate != <span class="keyword">null</span>) &#123;</div><div class="line">        closeQuietly(cacheCandidate.body());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">// 如果既有缓存，同时又发起了请求，说明此时是一个Conditional Get请求</span></div><div class="line">    <span class="keyword">if</span> (cacheResponse != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">// 如果服务端返回的是NOT_MODIFIED，缓存有效，将本地缓存和网络响应合并</span></div><div class="line">      <span class="keyword">if</span> (networkResponse.code() == HTTP_NOT_MODIFIED) &#123;</div><div class="line">        Response response = cacheResponse.newBuilder()</div><div class="line">            .headers(combine(cacheResponse.headers(), networkResponse.headers()))</div><div class="line">            .sentRequestAtMillis(networkResponse.sentRequestAtMillis())</div><div class="line">            .receivedResponseAtMillis(networkResponse.receivedResponseAtMillis())</div><div class="line">            .cacheResponse(stripBody(cacheResponse))</div><div class="line">            .networkResponse(stripBody(networkResponse))</div><div class="line">            .build();</div><div class="line">        networkResponse.body().close();</div><div class="line"></div><div class="line">        cache.trackConditionalCacheHit();</div><div class="line">        cache.update(cacheResponse, response);</div><div class="line">        <span class="keyword">return</span> response;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 如果响应资源有更新，关掉原有资源</span></div><div class="line">        closeQuietly(cacheResponse.body());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Response response = networkResponse.newBuilder()</div><div class="line">        .cacheResponse(stripBody(cacheResponse))</div><div class="line">        .networkResponse(stripBody(networkResponse))</div><div class="line">        .build();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (HttpHeaders.hasBody(response) &amp;&amp; CacheStrategy.isCacheable(response, networkRequest)) &#123;</div><div class="line">        <span class="comment">// 将网络响应写入cache中</span></div><div class="line">        CacheRequest cacheRequest = cache.put(response);</div><div class="line">        <span class="keyword">return</span> cacheWritingResponse(cacheRequest, response);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (HttpMethod.invalidatesCache(networkRequest.method())) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          cache.remove(networkRequest);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> response;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>接下来看一下缓存策略是如何生成的，相关代码实现在CacheStrategy.Factory.get()方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> CacheStrategy <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">   CacheStrategy candidate = getCandidate();</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (candidate.networkRequest != <span class="keyword">null</span> &amp;&amp; request.cacheControl().onlyIfCached()) &#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> CacheStrategy(<span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> candidate;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">private</span> CacheStrategy <span class="title">getCandidate</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// 若本地没有缓存，发起网络请求</span></div><div class="line">   <span class="keyword">if</span> (cacheResponse == <span class="keyword">null</span>) &#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> CacheStrategy(request, <span class="keyword">null</span>);</div><div class="line">   &#125;</div><div class="line"><span class="comment">// 如果当前请求是HTTPS，而缓存没有TSL握手，重新发起网络请求</span></div><div class="line">   <span class="keyword">if</span> (request.isHttps() &amp;&amp; cacheResponse.handshake() == <span class="keyword">null</span>) &#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> CacheStrategy(request, <span class="keyword">null</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (!isCacheable(cacheResponse, request)) &#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> CacheStrategy(request, <span class="keyword">null</span>);</div><div class="line">   &#125;</div><div class="line"><span class="comment">// 如果当前的缓存策略是不缓存或者是conditional get，发起网络请求</span></div><div class="line">   CacheControl requestCaching = request.cacheControl();</div><div class="line">   <span class="keyword">if</span> (requestCaching.noCache() || hasConditions(request)) &#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> CacheStrategy(request, <span class="keyword">null</span>);</div><div class="line">   &#125;</div><div class="line"><span class="comment">// 缓存age</span></div><div class="line">   <span class="keyword">long</span> ageMillis = cacheResponseAge();</div><div class="line">   <span class="comment">// 缓存保鲜时间</span></div><div class="line">   <span class="keyword">long</span> freshMillis = computeFreshnessLifetime();</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (requestCaching.maxAgeSeconds() != -<span class="number">1</span>) &#123;</div><div class="line">     freshMillis = Math.min(freshMillis, SECONDS.toMillis(requestCaching.maxAgeSeconds()));</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">long</span> minFreshMillis = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (requestCaching.minFreshSeconds() != -<span class="number">1</span>) &#123;</div><div class="line">     minFreshMillis = SECONDS.toMillis(requestCaching.minFreshSeconds());</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">long</span> maxStaleMillis = <span class="number">0</span>;</div><div class="line">   CacheControl responseCaching = cacheResponse.cacheControl();</div><div class="line">   <span class="keyword">if</span> (!responseCaching.mustRevalidate() &amp;&amp; requestCaching.maxStaleSeconds() != -<span class="number">1</span>) &#123;</div><div class="line">     maxStaleMillis = SECONDS.toMillis(requestCaching.maxStaleSeconds());</div><div class="line">   &#125;</div><div class="line"><span class="comment">//如果 age + min-fresh &gt;= max-age &amp;&amp; age + min-fresh &lt; max-age + max-stale，则虽然缓存过期了，         但是缓存继续可以使用，只是在头部添加 110 警告码</span></div><div class="line">   <span class="keyword">if</span> (!responseCaching.noCache() &amp;&amp; ageMillis + minFreshMillis &lt; freshMillis + maxStaleMillis) &#123;</div><div class="line">     Response.Builder builder = cacheResponse.newBuilder();</div><div class="line">     <span class="keyword">if</span> (ageMillis + minFreshMillis &gt;= freshMillis) &#123;</div><div class="line">       builder.addHeader(<span class="string">"Warning"</span>, <span class="string">"110 HttpURLConnection \"Response is stale\""</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">long</span> oneDayMillis = <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>;</div><div class="line">     <span class="keyword">if</span> (ageMillis &gt; oneDayMillis &amp;&amp; isFreshnessLifetimeHeuristic()) &#123;</div><div class="line">       builder.addHeader(<span class="string">"Warning"</span>, <span class="string">"113 HttpURLConnection \"Heuristic expiration\""</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> CacheStrategy(<span class="keyword">null</span>, builder.build());</div><div class="line">   &#125;</div><div class="line"><span class="comment">// 发起conditional get请求</span></div><div class="line">   String conditionName;</div><div class="line">   String conditionValue;</div><div class="line">   <span class="keyword">if</span> (etag != <span class="keyword">null</span>) &#123;</div><div class="line">     conditionName = <span class="string">"If-None-Match"</span>;</div><div class="line">     conditionValue = etag;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lastModified != <span class="keyword">null</span>) &#123;</div><div class="line">     conditionName = <span class="string">"If-Modified-Since"</span>;</div><div class="line">     conditionValue = lastModifiedString;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (servedDate != <span class="keyword">null</span>) &#123;</div><div class="line">     conditionName = <span class="string">"If-Modified-Since"</span>;</div><div class="line">     conditionValue = servedDateString;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> CacheStrategy(request, <span class="keyword">null</span>); </div><div class="line">   &#125;</div><div class="line"></div><div class="line">   Headers.Builder conditionalRequestHeaders = request.headers().newBuilder();</div><div class="line">   Internal.instance.addLenient(conditionalRequestHeaders, conditionName, conditionValue);</div><div class="line"></div><div class="line">   Request conditionalRequest = request.newBuilder()</div><div class="line">       .headers(conditionalRequestHeaders.build())</div><div class="line">       .build();</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> CacheStrategy(conditionalRequest, cacheResponse);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>可以看到其核心逻辑在getCandidate方法中，基本就是HTTP缓存策略的实现。</p>
<h4 id="DiskLruCache"><a href="#DiskLruCache" class="headerlink" title="DiskLruCache"></a>DiskLruCache</h4><p>Cache内部通过DiskLruCache管理cache在文件系统层面的创建，读取，清理等等工作，接下来看下DiskLruCache的主要逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DiskLruCache</span> <span class="keyword">implements</span> <span class="title">Closeable</span>, <span class="title">Flushable</span> </span>&#123;</div><div class="line">  ...</div><div class="line">  <span class="keyword">final</span> FileSystem fileSystem;</div><div class="line">  <span class="keyword">final</span> File directory;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> File journalFile;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> File journalFileTmp;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> File journalFileBackup;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> appVersion;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">long</span> maxSize;</div><div class="line">  <span class="keyword">final</span> <span class="keyword">int</span> valueCount;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">long</span> size = <span class="number">0</span>;</div><div class="line">  BufferedSink journalWriter;</div><div class="line">  <span class="keyword">final</span> LinkedHashMap&lt;String, Entry&gt; lruEntries = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(<span class="number">0</span>, <span class="number">0.75f</span>, <span class="keyword">true</span>);</div><div class="line">  <span class="keyword">int</span> redundantOpCount;</div><div class="line">  <span class="keyword">boolean</span> hasJournalErrors;</div><div class="line"></div><div class="line">  <span class="keyword">boolean</span> initialized;</div><div class="line">  <span class="keyword">boolean</span> closed;</div><div class="line">  <span class="keyword">boolean</span> mostRecentTrimFailed;</div><div class="line">  <span class="keyword">boolean</span> mostRecentRebuildFailed;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">long</span> nextSequenceNumber = <span class="number">0</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Executor executor;</div><div class="line">  </div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>journalFile：DiskLruCache内部日志文件，对cache的每一次读写都对应一条日志记录，DiskLruCache通过分析日志文件和创建cache。日志文件格式如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">libcore.io.DiskLruCache</div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">100</span></div><div class="line"><span class="number">2</span></div><div class="line"></div><div class="line">CLEAN <span class="number">3400330</span>d1dfc7f3f7f4b8d4d803dfcf6 <span class="number">832</span> <span class="number">21054</span></div><div class="line">DIRTY <span class="number">335</span>c4c6028171cfddfbaae1a9c313c52</div><div class="line">CLEAN <span class="number">335</span>c4c6028171cfddfbaae1a9c313c52 <span class="number">3934</span> <span class="number">2342</span></div><div class="line">REMOVE <span class="number">335</span>c4c6028171cfddfbaae1a9c313c52</div><div class="line">DIRTY <span class="number">1</span>ab96a171faeeee38496d8b330771a7a</div><div class="line">CLEAN <span class="number">1</span>ab96a171faeeee38496d8b330771a7a <span class="number">1600</span> <span class="number">234</span></div><div class="line">READ <span class="number">335</span>c4c6028171cfddfbaae1a9c313c52</div><div class="line">READ <span class="number">3400330</span>d1dfc7f3f7f4b8d4d803dfcf6</div><div class="line"></div><div class="line">前<span class="number">5</span>行固定不变，分别为：常量：libcore.io.DiskLruCache；diskCache版本；应用程序版本;valueCount(后      文介绍)，空行</div><div class="line"></div><div class="line">接下来每一行对应一个cache entry的一次状态记录，其格式为：[状态（DIRTY,CLEAN,READ,REMOVE），key，状态相关value(可选)]:</div><div class="line">- DIRTY:表明一个cache entry正在被创建或更新，每一个成功的DIRTY记录都应该对应一个CLEAN或REMOVE操				作。如果一个DIRTY缺少预期匹配的CLEAN/REMOVE，则对应entry操作失败，需要将其从lruEntries				  中删除。</div><div class="line">- CLEAN:说明cache已经被成功操作，当前可以被正常读取。每一个CLEAN行还需要记录其每一个value的长度。</div><div class="line">- READ: 记录一次cache读取操作。</div><div class="line">- REMOVE:记录一次cache清除。</div></pre></td></tr></table></figure>
<p>日志文件的应用场景主要有四个：</p>
<ul>
<li>DiskCacheLru初始化时通过读取日志创建cache容器：lruEntries。同时通过日志过滤操作不成功的cache项</li>
<li>初始化完成后，为避免日志文件不断膨胀，对日志进行重建精简</li>
<li>每当有cache操作时将其记录入日志文件中以备下次初始化时使用</li>
<li>当冗余日志过多时，通过调用cleanUpRunnable线程重建日志</li>
</ul>
</li>
<li><p>DiskLruCache.Entry：每一个DiskLruCache.Entry对应一个cache记录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> </span>&#123;</div><div class="line">  <span class="keyword">final</span> String key;</div><div class="line"></div><div class="line">  <span class="keyword">final</span> <span class="keyword">long</span>[] lengths;</div><div class="line">  <span class="keyword">final</span> File[] cleanFiles;</div><div class="line">  <span class="keyword">final</span> File[] dirtyFiles;</div><div class="line"></div><div class="line">  <span class="keyword">boolean</span> readable;</div><div class="line"></div><div class="line">  Editor currentEditor;</div><div class="line"></div><div class="line">  <span class="keyword">long</span> sequenceNumber;</div><div class="line"></div><div class="line">  Entry(String key) &#123;</div><div class="line">    <span class="keyword">this</span>.key = key;</div><div class="line"></div><div class="line">    lengths = <span class="keyword">new</span> <span class="keyword">long</span>[valueCount];</div><div class="line">    cleanFiles = <span class="keyword">new</span> File[valueCount];</div><div class="line">    dirtyFiles = <span class="keyword">new</span> File[valueCount];</div><div class="line"></div><div class="line">    StringBuilder fileBuilder = <span class="keyword">new</span> StringBuilder(key).append(<span class="string">'.'</span>);</div><div class="line">    <span class="keyword">int</span> truncateTo = fileBuilder.length();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">      fileBuilder.append(i);</div><div class="line">      cleanFiles[i] = <span class="keyword">new</span> File(directory, fileBuilder.toString());</div><div class="line">      fileBuilder.append(<span class="string">".tmp"</span>);</div><div class="line">      dirtyFiles[i] = <span class="keyword">new</span> File(directory, fileBuilder.toString());</div><div class="line">      fileBuilder.setLength(truncateTo);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setLengths</span><span class="params">(String[] strings)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (strings.length != valueCount) &#123;</div><div class="line">      <span class="keyword">throw</span> invalidLengths(strings);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; strings.length; i++) &#123;</div><div class="line">        lengths[i] = Long.parseLong(strings[i]);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">      <span class="keyword">throw</span> invalidLengths(strings);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">writeLengths</span><span class="params">(BufferedSink writer)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> length : lengths) &#123;</div><div class="line">      writer.writeByte(<span class="string">' '</span>).writeDecimalLong(length);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> IOException <span class="title">invalidLengths</span><span class="params">(String[] strings)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"unexpected journal line: "</span> + Arrays.toString(strings));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function">Snapshot <span class="title">snapshot</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!Thread.holdsLock(DiskLruCache.<span class="keyword">this</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line"></div><div class="line">    Source[] sources = <span class="keyword">new</span> Source[valueCount];</div><div class="line">    <span class="keyword">long</span>[] lengths = <span class="keyword">this</span>.lengths.clone(); </div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">        sources[i] = fileSystem.source(cleanFiles[i]);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Snapshot(key, sequenceNumber, sources, lengths);</div><div class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (sources[i] != <span class="keyword">null</span>) &#123;</div><div class="line">          Util.closeQuietly(sources[i]);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        removeEntry(<span class="keyword">this</span>);</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一个Entry主要由以下几部分构成：</p>
<ul>
<li>key：每个cache都有一个key作为其标识符。当前cache的key为其对应URL的MD5字符串</li>
<li>cleanFiles / dirtyFiles：每一个Entry对应多个文件，其对应的文件数由DiskLruCache.valueCount指定。当前在Okttp中valueCount为2.即每个cache对应2个cleanFiles，2个DirtyFiles。其中第一个cleanFiles / dirtyFiles记录cache的meta数据（如URL，创建时间，SSL握手记录等等），第二个文件记录cache的真正内容。cleanFiles记录处于稳定状态的cache结果，dirtyFiles记录处于创建或更新状态的cache</li>
<li>currentEditor：entry编辑器，对entry的所有操作都是通过其编辑器完成，编辑器内部添加了同步锁</li>
</ul>
</li>
<li><p>cleanRunnable：清理线程，用于重建精简日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable cleanupRunnable = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">synchronized</span> (DiskLruCache.<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!initialized | closed) &#123;</div><div class="line">          <span class="keyword">return</span>; </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          trimToSize();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</div><div class="line">          mostRecentTrimFailed = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">if</span> (journalRebuildRequired()) &#123;</div><div class="line">            rebuildJournal();</div><div class="line">            redundantOpCount = <span class="number">0</span>;</div><div class="line">          &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">          mostRecentRebuildFailed = <span class="keyword">true</span>;</div><div class="line">          journalWriter = Okio.buffer(Okio.blackhole());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div></pre></td></tr></table></figure>
<p>其触发条件在journalRebuildRequired()方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">journalRebuildRequired</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">final</span> <span class="keyword">int</span> redundantOpCompactThreshold = <span class="number">2000</span>;</div><div class="line">  <span class="keyword">return</span> redundantOpCount &gt;= redundantOpCompactThreshold</div><div class="line">      &amp;&amp; redundantOpCount &gt;= lruEntries.size();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当冗余日志超过日志文件本身的一般且总条数超过2000时执行。</p>
</li>
<li><p>SnapShot：cache快照，记录了特定cache在某一个特定时刻的内容。每次向DiskLruCache请求时返回的都是目标cache的一个快照，相关逻辑在DiskLruCache.get方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Snapshot <span class="title">get</span><span class="params">(String key)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  initialize();</div><div class="line"></div><div class="line">  checkNotClosed();</div><div class="line">  validateKey(key);</div><div class="line">  Entry entry = lruEntries.get(key);</div><div class="line">  <span class="keyword">if</span> (entry == <span class="keyword">null</span> || !entry.readable) <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"></div><div class="line">  Snapshot snapshot = entry.snapshot();</div><div class="line">  <span class="keyword">if</span> (snapshot == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"></div><div class="line">  redundantOpCount++;</div><div class="line">  journalWriter.writeUtf8(READ).writeByte(<span class="string">' '</span>).writeUtf8(key).writeByte(<span class="string">'\n'</span>);</div><div class="line">  <span class="keyword">if</span> (journalRebuildRequired()) &#123;</div><div class="line">    executor.execute(cleanupRunnable);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> snapshot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>LruEntries：管理cache entry的容器，其数据结构是LinkedHashMap。通过LinkedHashMap本身的实现逻辑达到cache的LRU替换。</p>
</li>
<li><p>FileSystem：使用okio对File的封装，简化了I / O操作。</p>
</li>
<li><p>DiskLruCache.edit：DiskLruCache可以看成是Cache在文件系统层的具体实现，所以其基本操作接口存在一一对应的关系。</p>
<ul>
<li>Cache.get() ——&gt; DiskLruCache.get()</li>
<li>Cache.put() ——&gt; DiskLruCache.edit()</li>
<li>Cache.remove() ——&gt; DiskLruCache.remove()</li>
<li>Cache.update() ——&gt; DiskLruCache.edit()</li>
</ul>
<p>首先看一下Cache.put操作的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Nullable</span> </div><div class="line"><span class="function">CacheRequest <span class="title">put</span><span class="params">(Response response)</span> </span>&#123;</div><div class="line">    String requestMethod = response.request().method();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (HttpMethod.invalidatesCache(response.request().method())) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        remove(response.request());</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</div><div class="line"></div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!requestMethod.equals(<span class="string">"GET"</span>)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (HttpHeaders.hasVaryAll(response)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Entry entry = <span class="keyword">new</span> Entry(response);</div><div class="line">    DiskLruCache.Editor editor = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      editor = cache.edit(key(response.request().url()));</div><div class="line">      <span class="keyword">if</span> (editor == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">      entry.writeTo(editor);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> CacheRequestImpl(editor);</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      abortQuietly(editor);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>可以看到核心逻辑代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">editor = cache.edit(key(response.request().url()));</div></pre></td></tr></table></figure>
<p>相关代码在DiskLruCache.edit方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">Editor <span class="title">edit</span><span class="params">(String key)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">return</span> edit(key, ANY_SEQUENCE_NUMBER);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">synchronized</span> Editor <span class="title">edit</span><span class="params">(String key, <span class="keyword">long</span> expectedSequenceNumber)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    initialize();</div><div class="line"></div><div class="line">    checkNotClosed();</div><div class="line">    validateKey(key);</div><div class="line">    Entry entry = lruEntries.get(key);</div><div class="line">    <span class="keyword">if</span> (expectedSequenceNumber != ANY_SEQUENCE_NUMBER &amp;&amp; (entry == <span class="keyword">null</span></div><div class="line">        || entry.sequenceNumber != expectedSequenceNumber)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>; </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (entry != <span class="keyword">null</span> &amp;&amp; entry.currentEditor != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>; </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mostRecentTrimFailed || mostRecentRebuildFailed) &#123;</div><div class="line"></div><div class="line">      executor.execute(cleanupRunnable);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    journalWriter.writeUtf8(DIRTY).writeByte(<span class="string">' '</span>).writeUtf8(key).writeByte(<span class="string">'\n'</span>);</div><div class="line">    journalWriter.flush();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasJournalErrors) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>; </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">      entry = <span class="keyword">new</span> Entry(key);</div><div class="line">      lruEntries.put(key, entry);</div><div class="line">    &#125;</div><div class="line">    Editor editor = <span class="keyword">new</span> Editor(entry);</div><div class="line">    entry.currentEditor = editor;</div><div class="line">    <span class="keyword">return</span> editor;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>edit方法返回对应CacheEntry的editor编辑器。接下来再来看下Cache.put()方法的entry.writeTo(editor)相关逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(DiskLruCache.Editor editor)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  BufferedSink sink = Okio.buffer(editor.newSink(ENTRY_METADATA));</div><div class="line"></div><div class="line">  sink.writeUtf8(url)</div><div class="line">      .writeByte(<span class="string">'\n'</span>);</div><div class="line">  sink.writeUtf8(requestMethod)</div><div class="line">      .writeByte(<span class="string">'\n'</span>);</div><div class="line">  sink.writeDecimalLong(varyHeaders.size())</div><div class="line">      .writeByte(<span class="string">'\n'</span>);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = varyHeaders.size(); i &lt; size; i++) &#123;</div><div class="line">    sink.writeUtf8(varyHeaders.name(i))</div><div class="line">        .writeUtf8(<span class="string">": "</span>)</div><div class="line">        .writeUtf8(varyHeaders.value(i))</div><div class="line">        .writeByte(<span class="string">'\n'</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  sink.writeUtf8(<span class="keyword">new</span> StatusLine(protocol, code, message).toString())</div><div class="line">      .writeByte(<span class="string">'\n'</span>);</div><div class="line">  sink.writeDecimalLong(responseHeaders.size() + <span class="number">2</span>)</div><div class="line">      .writeByte(<span class="string">'\n'</span>);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = responseHeaders.size(); i &lt; size; i++) &#123;</div><div class="line">    sink.writeUtf8(responseHeaders.name(i))</div><div class="line">        .writeUtf8(<span class="string">": "</span>)</div><div class="line">        .writeUtf8(responseHeaders.value(i))</div><div class="line">        .writeByte(<span class="string">'\n'</span>);</div><div class="line">  &#125;</div><div class="line">  sink.writeUtf8(SENT_MILLIS)</div><div class="line">      .writeUtf8(<span class="string">": "</span>)</div><div class="line">      .writeDecimalLong(sentRequestMillis)</div><div class="line">      .writeByte(<span class="string">'\n'</span>);</div><div class="line">  sink.writeUtf8(RECEIVED_MILLIS)</div><div class="line">      .writeUtf8(<span class="string">": "</span>)</div><div class="line">      .writeDecimalLong(receivedResponseMillis)</div><div class="line">      .writeByte(<span class="string">'\n'</span>);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (isHttps()) &#123;</div><div class="line">    sink.writeByte(<span class="string">'\n'</span>);</div><div class="line">    sink.writeUtf8(handshake.cipherSuite().javaName())</div><div class="line">        .writeByte(<span class="string">'\n'</span>);</div><div class="line">    writeCertList(sink, handshake.peerCertificates());</div><div class="line">    writeCertList(sink, handshake.localCertificates());</div><div class="line">    sink.writeUtf8(handshake.tlsVersion().javaName()).writeByte(<span class="string">'\n'</span>);</div><div class="line">  &#125;</div><div class="line">  sink.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其主要逻辑就是将对应请求的meta数据写入对应CacheEntry的索引为ENTRY_METADATA（0）的dirtyfile中。</p>
<p>最后再来看Cache.put()方法的返回值：return new CacheRequestImpl(editor)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheRequestImpl</span> <span class="keyword">implements</span> <span class="title">CacheRequest</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DiskLruCache.Editor editor;</div><div class="line">  <span class="keyword">private</span> Sink cacheOut;</div><div class="line">  <span class="keyword">private</span> Sink body;</div><div class="line">  <span class="keyword">boolean</span> done;</div><div class="line"></div><div class="line">  CacheRequestImpl(<span class="keyword">final</span> DiskLruCache.Editor editor) &#123;</div><div class="line">    <span class="keyword">this</span>.editor = editor;</div><div class="line">    <span class="keyword">this</span>.cacheOut = editor.newSink(ENTRY_BODY);</div><div class="line">    <span class="keyword">this</span>.body = <span class="keyword">new</span> ForwardingSink(cacheOut) &#123;</div><div class="line">      </div><div class="line">  <span class="meta">@Override</span> </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (Cache.<span class="keyword">this</span>) &#123;</div><div class="line">          <span class="keyword">if</span> (done) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">          &#125;</div><div class="line">          done = <span class="keyword">true</span>;</div><div class="line">          writeSuccessCount++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.close();</div><div class="line">        editor.commit();</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">abort</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (Cache.<span class="keyword">this</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (done) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      done = <span class="keyword">true</span>;</div><div class="line">      writeAbortCount++;</div><div class="line">    &#125;</div><div class="line">    Util.closeQuietly(cacheOut);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      editor.abort();</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Sink <span class="title">body</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> body;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CacheRequestImpl实现CacheRequest接口，向外部类(主要是CacheInterceptor)透出，外部对象通过CacheRequestImpl更新或写入缓存数据。</p>
<p>其中，close方法和abort方法会调用editor.commit和editor.abort；来更新日志，editor.commit还会将dirtyFile重置为cleanFile作为稳定可用的缓存，相关逻辑如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  <span class="keyword">synchronized</span> (DiskLruCache.<span class="keyword">this</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (done) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (entry.currentEditor == <span class="keyword">this</span>) &#123;</div><div class="line">      completeEdit(<span class="keyword">this</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    done = <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">completeEdit</span><span class="params">(Editor editor, <span class="keyword">boolean</span> success)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Entry entry = editor.entry;</div><div class="line">    <span class="keyword">if</span> (entry.currentEditor != editor) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (success &amp;&amp; !entry.readable) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (!editor.written[i]) &#123;</div><div class="line">          editor.abort();</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Newly created entry didn't create value for index "</span> + i);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!fileSystem.exists(entry.dirtyFiles[i])) &#123;</div><div class="line">          editor.abort();</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">      File dirty = entry.dirtyFiles[i];</div><div class="line">      <span class="keyword">if</span> (success) &#123;</div><div class="line">        <span class="keyword">if</span> (fileSystem.exists(dirty)) &#123;</div><div class="line">          File clean = entry.cleanFiles[i];</div><div class="line">          fileSystem.rename(dirty, clean);</div><div class="line">          <span class="keyword">long</span> oldLength = entry.lengths[i];</div><div class="line">          <span class="keyword">long</span> newLength = fileSystem.size(clean);</div><div class="line">          entry.lengths[i] = newLength;</div><div class="line">          size = size - oldLength + newLength;</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fileSystem.delete(dirty);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    redundantOpCount++;</div><div class="line">    entry.currentEditor = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (entry.readable | success) &#123;</div><div class="line">      entry.readable = <span class="keyword">true</span>;</div><div class="line">      journalWriter.writeUtf8(CLEAN).writeByte(<span class="string">' '</span>);</div><div class="line">      journalWriter.writeUtf8(entry.key);</div><div class="line">      entry.writeLengths(journalWriter);</div><div class="line">      journalWriter.writeByte(<span class="string">'\n'</span>);</div><div class="line">      <span class="keyword">if</span> (success) &#123;</div><div class="line">        entry.sequenceNumber = nextSequenceNumber++;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      lruEntries.remove(entry.key);</div><div class="line">      journalWriter.writeUtf8(REMOVE).writeByte(<span class="string">' '</span>);</div><div class="line">      journalWriter.writeUtf8(entry.key);</div><div class="line">      journalWriter.writeByte(<span class="string">'\n'</span>);</div><div class="line">    &#125;</div><div class="line">    journalWriter.flush();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (size &gt; maxSize || journalRebuildRequired()) &#123;</div><div class="line">      executor.execute(cleanupRunnable);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>DiskLruCache主要有以下几个特点：</p>
<ul>
<li>通过LinkedHashMap实现LRU替换</li>
<li>通过本地维护Cache操作日志保证Cache原子性与可用性，同时为防止日志过分膨胀定时执行日志精简</li>
<li>每一个Cache项对应两个状态副本：DIRTY，CLEAN。CLEAN表示当前可用状态Cache，外部访问到cache快照均为CLEAN状态；DIRTY为更新态Cache。由于更新和创建都只操作DIRTY状态副本，实现了Cache的读写分离</li>
<li>每一个Cache项有四个文件，两个状态（DIRTY，CLEAN），每个状态对应两个文件，一个文件存储Cache meta数据，一个文件存储Cache内容数据</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android框架源码解析/" rel="tag"># android框架源码解析</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/25/OkHttp框架源码解析（三）/" rel="next" title="OkHttp框架源码解析——任务队列">
                <i class="fa fa-chevron-left"></i> OkHttp框架源码解析——任务队列
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/26/OkHttp框架源码解析（五）/" rel="prev" title="OkHttp框架源码解析——多路复用">
                OkHttp框架源码解析——多路复用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/icon.jpg"
                alt="sufushi" />
            
              <p class="site-author-name" itemprop="name">sufushi</p>
              <p class="site-description motion-element" itemprop="description">这是苏富仕的博客</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">53</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/sufushi" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Cache源码分析"><span class="nav-number">2.</span> <span class="nav-text">Cache源码分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DiskLruCache"><span class="nav-number">3.</span> <span class="nav-text">DiskLruCache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结"><span class="nav-number">4.</span> <span class="nav-text">小结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sufushi</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.3"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.3"></script>


  

</body>
</html>
